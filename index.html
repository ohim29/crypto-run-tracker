<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
    <meta name="color-scheme" content="dark light" />
    <meta name="theme-color" content="#0f172a" />
    <link rel="manifest" href="./manifest.json">
    <title>Crypto Run Tracker ‚Äî Binance Futures</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://s3.tradingview.com" crossorigin>
    <link rel="preconnect" href="https://fapi.binance.com" crossorigin>
    <link rel="preconnect" href="https://fstream.binance.com" crossorigin>
    <style>
      :root{--bg:#0f172a;--pane:#1f2937;--br:#334155;}
      body{background:radial-gradient(100% 100% at 50% 0%, #1e1b4b 0%, #0f172a 60%, #0f172a 100%);color:#e5e7eb}
      .card{background:rgba(30,41,59,.5);backdrop-filter:blur(6px);border:1px solid #334155;border-radius:1rem}
      .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.55rem 1rem;border-radius:.8rem;border:1px solid #475569;background:rgba(51,65,85,.5);min-height:44px}
      .btn:hover{background:rgba(51,65,85,.8)}
      .pill{padding:.15rem .5rem;border-radius:.5rem;border:1px solid #475569}
      .scroll-area{scrollbar-width:thin;scrollbar-color:#475569 transparent}
      .scroll-area::-webkit-scrollbar{width:8px}.scroll-area::-webkit-scrollbar-thumb{background:#475569;border-radius:8px}
      #tv-container{width:100%;height:560px}@media(max-width:1024px){#tv-container{height:440px}}@media(max-width:640px){#tv-container{height:380px}}
      .tools-btn{font-size:.95rem;padding:.45rem .8rem;border-radius:.6rem;border:1px solid #475569;background:rgba(51,65,85,.5)}
      .tools-btn.active{border-color:#7c3aed;background:rgba(124,58,237,.18)}
          .bar{height:10px;background:rgba(148,163,184,.25);border-radius:4px;overflow:hidden}
      .bar>div{height:100%;background:rgba(124,58,237,.7)}
      td .bar{max-width:100%;}
          .col-right{display:flex;flex-direction:column}
      .col-right>.card:last-child{flex:1;display:flex;flex-direction:column}
      .col-right>.card:last-child>#toolsContent{flex:1;}
    </style>
  </head>
  <body>
    <div class="min-h-screen">
      <div class="container mx-auto px-3 sm:px-4 py-4 sm:py-6">
        <div class="text-center mb-4 sm:mb-6">
          <h1 class="text-2xl sm:text-3xl font-bold">Crypto Run Tracker</h1>
        </div>

        <div class="card p-3 sm:p-4 mb-4 sm:mb-6">
          <div class="flex flex-col lg:flex-row gap-3 items-stretch lg:items-center justify-between">
            <div class="relative flex-1 w-full flex gap-2">
              <div class="relative flex-1">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 select-none">üîé</span>
                <input id="searchInput" class="w-full pl-10 pr-10 py-2 bg-slate-700/50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="–ü–æ–∏—Å–∫: BTC / BTCUSDT" />
                <button id="clearSearch" title="–û—á–∏—Å—Ç–∏—Ç—å" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-200">‚úï</button>
              </div>
              <button id="searchBtn" class="btn text-white" type="button">–ù–∞–π—Ç–∏</button>
            </div>
            <div class="flex items-center gap-2">
              <span class="hidden sm:inline pill" id="marketInfo">–ü–∞—Ä—ã: ‚Äî</span>
              <button id="togglePricesBtn" class="btn text-white" type="button">üôà –°–∫—Ä—ã—Ç—å —Ü–µ–Ω—ã</button>
            </div>
          </div>
          <div id="statusBar" class="mt-2 text-xs text-slate-300"></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6 items-stretch" style="min-height: 720px;">
          <div class="lg:col-span-1 card p-4 flex flex-col">
            <div class="mb-3">
              <h2 class="text-xl font-bold">–¢–æ–ø —Ñ—å—é—á–µ—Ä—Å–æ–≤ (USDT‚ÄëPERP)</h2>
              <div id="filterHint" class="text-xs text-slate-400"></div>
            </div>
            <div class="flex gap-2 mb-3">
              <button id="btnGainers" class="btn flex-1 text-white bg-green-600/80 border-green-700" type="button">üìà –†–æ—Å—Ç</button>
              <button id="btnLosers" class="btn flex-1 text-white" type="button">üìâ –ü–∞–¥–µ–Ω–∏–µ</button>
            </div>
            <div id="screenerList" class="scroll-area overflow-y-auto"></div>
          </div>

          <div class="lg:col-span-2 space-y-4 col-right">
            <div class="card p-4">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div id="assetAvatar" class="w-10 h-10 rounded-full bg-slate-700 grid place-items-center text-white font-bold">‚Äî</div>
                  <div><h3 id="assetName" class="font-semibold text-lg">‚Äî</h3><p id="assetSymbol" class="text-slate-400 text-sm">‚Äî</p></div>
                </div>
                <div class="text-right">
                  <div id="assetPrice" class="font-mono text-xl">‚Ä¶</div>
                  <div id="assetChange" class="text-sm font-semibold">‚Äî</div>
                </div>
              </div>
            </div>

            <div class="card p-0 overflow-hidden"><div id="tv-container"></div></div>

            <div class="card">
              <div class="sticky top-0 p-2 border-b border-slate-700 bg-slate-900/60 backdrop-blur-sm rounded-t-xl flex gap-2 flex-wrap">
                <button class="tools-btn" data-tool="volumes">–û–±—ä—ë–º—ã</button>
                <button class="tools-btn" data-tool="listings">–õ–∏—Å—Ç–∏–Ω–≥–∏</button>
                <button class="tools-btn" data-tool="signals">–°–∏–≥–Ω–∞–ª—ã</button>
                <button class="tools-btn" data-tool="news">–ù–æ–≤–æ—Å—Ç–∏</button>
              </div>
              <div id="toolsContent" class="p-3"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js');

      const fmtMoney = (v) => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:v<1?4:2,maximumFractionDigits:v<1?6:2}).format(v);
      const n2=(v)=>Number(v).toFixed(2); const pct=(v)=> isFinite(v)?((v>=0?'+':'')+Number(v).toFixed(2)+'%'):'‚Äî';

      const state = {
        map:{}, list:[], selected:null,
        showPrices:true, screenerView:'gainers', search:'',
        prevVisibleSet:new Set(), wsConnected:false,
        activeTool:'volumes',
        params:{ signals:{ rsi:14, ma:50, ema:200, macd:{fast:12,slow:26,sig:9}, tfs:['5m','15m','1h','4h'] } }
      };

      const el={
        search:document.getElementById('searchInput'),
        clear:document.getElementById('clearSearch'),
        searchBtn:document.getElementById('searchBtn'),
        toggle:document.getElementById('togglePricesBtn'),
        gainers:document.getElementById('btnGainers'),
        losers:document.getElementById('btnLosers'),
        screener:document.getElementById('screenerList'),
        status:document.getElementById('statusBar'),
        hint:document.getElementById('filterHint'),
        marketInfo:document.getElementById('marketInfo'),
        toolsContent:document.getElementById('toolsContent'),
      };

      function enforceViewportRows(){
        const r = el.screener.querySelector('.row-crypto');
        const h = r ? r.getBoundingClientRect().height : 64;
        const isMobile = window.matchMedia('(max-width: 767px)').matches;
        const rows = isMobile ? 5 : 18;
        el.screener.style.maxHeight = (h*rows) + 'px';
      }

      function renderStatus(){
        const count = state.list.length;
        el.status.innerHTML = `<span class="${state.wsConnected?'text-green-400':'text-red-400'}">WS: ${state.wsConnected?'–ø–æ–¥–∫–ª—é—á–µ–Ω–æ':'–Ω–µ—Ç'}</span> <span class="ml-2 text-slate-400">–ü–∞—Ä—ã: ${count||'‚Äî'}</span>`;
        if (el.marketInfo) el.marketInfo.textContent='–ü–∞—Ä—ã: '+(count||'‚Äî');
      }

      let tvWidget=null;
      function ensureTV(cb){
        if (window.TradingView && window.TradingView.widget) return cb();
        if (document.getElementById('tvjs')) return setTimeout(cb,120);
        const s=document.createElement('script'); s.id='tvjs'; s.src='https://s3.tradingview.com/tv.js'; s.onload=cb; document.body.appendChild(s);
      }
      function renderTV(symbol){
        ensureTV(()=>{
          if (!window.TradingView) return;
          if (tvWidget && tvWidget.remove) try{tvWidget.remove();}catch(e){}
          tvWidget = new window.TradingView.widget({
            autosize:true, symbol:'BINANCE:'+symbol+'.P', interval:'60', theme:'dark', style:'1', locale:'en',
            container_id:'tv-container', hide_top_toolbar:false, hide_side_toolbar:false, toolbar_bg:'#0f172a', withdateranges:true, details:true, hotlist:true, calendar:true,
            overrides:{'paneProperties.background':'#0f172a','paneProperties.vertGridProperties.color':'#374151','paneProperties.horzGridProperties.color':'#374151'}
          });
        });
      }

      async function loadMarkets(){
        const ex = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo').then(r=>r.json());
        const usdt = ex.symbols.filter(s=>s.status==='TRADING' && s.quoteAsset==='USDT' && s.contractType==='PERPETUAL')
          .map(s=>({symbol:s.symbol, base:s.baseAsset, quote:s.quoteAsset, onboard:s.onboardDate}));
        const t = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json());
        const mapT=Object.fromEntries(t.map(x=>[x.symbol,x]));
        state.map={}; state.list=[];
        for (const s of usdt){
          const tt=mapT[s.symbol]; if(!tt) continue;
          state.map[s.symbol]={...s, price:+tt.lastPrice, change24h:+tt.priceChangePercent, volumeQuote:+tt.quoteVolume, volumeBase:+tt.volume, high:+tt.highPrice, low:+tt.lowPrice};
          state.list.push(s.symbol);
        }
        state.list.sort((a,b)=> (state.map[b].volumeQuote||0)-(state.map[a].volumeQuote||0));
        state.selected = state.list[0]||'BTCUSDT';
      }

      function startWS(){
        const ws = new WebSocket('wss://fstream.binance.com/stream?streams=!ticker@arr');
        ws.onopen=()=>{state.wsConnected=true; renderStatus();};
        ws.onmessage=(e)=>{
          const msg=JSON.parse(e.data); const arr=msg && msg.data; if(!Array.isArray(arr)) return;
          for(const t of arr){ const s=t.s; const e=state.map[s]; if(!e) continue; e.price=+t.c; e.change24h=+t.P; e.volumeQuote=+t.q; e.volumeBase=+t.v; }
          renderHeader(); maybeRenderScreener(); if(state.activeTool==='volumes') renderTool('volumes');
        };
        ws.onclose=()=>{state.wsConnected=false; renderStatus(); setTimeout(startWS,1500);};
        ws.onerror=()=>{state.wsConnected=false; renderStatus();};
      }

      function renderHeader(){
        const c=state.map[state.selected]; if(!c) return;
        document.getElementById('assetAvatar').textContent=(c.base||'?').slice(0,3);
        document.getElementById('assetName').textContent=c.base+' PERP';
        document.getElementById('assetSymbol').textContent=c.symbol+' (Futures)';
        document.getElementById('assetPrice').textContent=c.price!=null ? (state.showPrices?fmtMoney(c.price):'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'):'‚Ä¶';
        const ch=Number(c.change24h), elC=document.getElementById('assetChange');
        if(isFinite(ch)){ elC.textContent=`${ch>=0?'+':''}${ch.toFixed(2)}% 24h`; elC.className=`text-sm font-semibold ${ch>=0?'text-green-400':'text-red-400'}`;}
        else { elC.textContent='‚Äî'; elC.className='text-sm font-semibold text-slate-400'; }
      }

      function filteredSymbols(){
        const q=state.search.trim().toLowerCase(); if(!q) return state.list;
        return state.list.filter(sym=>{
          const e=state.map[sym]; return e.symbol.toLowerCase().includes(q) || e.base.toLowerCase().includes(q);
        });
      }
      function screenerOrder(list){
        const entries=list.map(sym=>state.map[sym]).filter(Boolean);
        return (state.screenerView==='gainers') ? entries.sort((a,b)=> (b.change24h)-(a.change24h)) : entries.sort((a,b)=> (a.change24h)-(b.change24h));
      }
      function renderScreener(){
        const q=state.search.trim(); const pool=filteredSymbols(); let entries=screenerOrder(pool); let hint='';
        if(q && pool.length===0){ entries=screenerOrder(state.list); hint=`–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ ‚Äú${q}‚Äù. –ü–æ–∫–∞–∑–∞–Ω –æ–±—â–∏–π —Ç–æ–ø.`; }
        el.hint.textContent=hint;
        const visible=entries.slice(0,18).map(c=>c.symbol); state.prevVisibleSet=new Set(visible);
        const rows=entries.map((c,idx)=>{
          const isSel=c.symbol===state.selected;
          const change=c.change24h, cls=isFinite(change)?(change>=0?'text-green-400':'text-red-400'):'text-slate-400';
          const priceText=c.price!=null?(state.showPrices?fmtMoney(c.price):'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'):'‚Ä¶';
          return `<div class="row-crypto p-3 rounded-lg cursor-pointer transition-all ${isSel?'bg-slate-700 border border-purple-500':'bg-slate-700/30 hover:bg-slate-700/50'}" data-sym="${c.symbol}">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-slate-700 grid place-items-center text-xs font-bold">${c.base.slice(0,3)}</div>
                <div><div class="font-semibold text-sm">${c.base} PERP</div><div class="text-slate-400 text-xs">${c.symbol}</div></div>
              </div>
              <div class="text-right">
                <div class="font-mono text-sm">${priceText}</div>
                <div class="text-xs font-semibold ${cls}">${isFinite(change)?(change>=0?'+':'')+change.toFixed(2)+'%':'‚Äî'}</div>
              </div>
            </div></div>`;
        }).join('');
        el.screener.innerHTML = rows || '<div class="text-slate-400 text-sm">–î–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç‚Ä¶</div>';
        el.screener.querySelectorAll('[data-sym]').forEach(n=> n.onclick=()=>{ const s=n.getAttribute('data-sym'); if(state.map[s]){ state.selected=s; renderHeader(); renderTV(s); renderScreener(); renderTool(state.activeTool); }});
        enforceViewportRows();
      }
      function maybeRenderScreener(){ renderScreener(); }

      function applySearch(){
        state.search=el.search.value||'';
        const m=filteredSymbols();
        if(state.search.trim() && m.length>0){ const first=m[0]; if(first && first!==state.selected){ state.selected=first; renderHeader(); renderTV(first);} }
        renderScreener(); if(state.activeTool) renderTool(state.activeTool);
      }

      function renderTool(mode){
        if(mode==='volumes') return renderToolVolumes();
        if(mode==='listings') return renderToolListings();
        if(mode==='signals') return renderToolSignals();
        if(mode==='news') return renderToolNews();
      }

      
      
      function renderToolVolumes(){
        const data = state.list.map(s=>state.map[s]).filter(Boolean).sort((a,b)=>(b.volumeQuote||0)-(a.volumeQuote||0)).slice(0,200);
        const maxBase = Math.max(...data.map(c=>Number(c.volumeBase||0)), 1);
        const maxQuote = Math.max(...data.map(c=>Number(c.volumeQuote||0)), 1);
        const isMobile = window.matchMedia('(max-width: 767px)').matches;

        if (isMobile) {
          // Render cards for mobile
          const cards = data.map((c,i)=>{
            const vb = Number(c.volumeBase||0);
            const vq = Number(c.volumeQuote||0);
            const wb = Math.max(2, Math.round((vb/maxBase)*100));
            const wq = Math.max(2, Math.round((vq/maxQuote)*100));
            const change = Number(c.change24h);
            const chClass = isFinite(change) ? (change>=0?'text-green-400':'text-red-400') : 'text-slate-400';
            const chText = isFinite(change) ? `${change>=0?'+':''}${change.toFixed(2)}%` : '‚Äî';
            return `<div class="rounded-xl border border-slate-700 p-3 mb-3 bg-slate-800/40">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <span class="pill text-xs">${i+1}</span>
                  <span class="pill">${c.symbol}</span>
                </div>
                <div class="text-right ${chClass} text-sm font-semibold">${chText}</div>
              </div>
              <div class="grid grid-cols-1 gap-2">
                <div>
                  <div class="text-xs text-slate-400 mb-1">–û–±—ä—ë–º (base)</div>
                  <div class="bar"><div style="width:${wb}%"></div></div>
                  <div class="font-mono text-sm mt-1">${vb.toLocaleString('en-US')}</div>
                </div>
                <div>
                  <div class="text-xs text-slate-400 mb-1">–û–±—ä—ë–º (USDT)</div>
                  <div class="bar"><div style="width:${wq}%"></div></div>
                  <div class="font-mono text-sm mt-1">${fmtMoney(vq)}</div>
                </div>
              </div>
            </div>`;
          }).join('');

          el.toolsContent.innerHTML = `
            <div class="mb-2 text-slate-300">–†–µ–π—Ç–∏–Ω–≥ –ø–æ 24—á –æ–±—ä—ë–º—É</div>
            <div class="scroll-area" style="max-height: 396px; overflow-y:auto;">
              ${cards}
            </div>`;
          return;
        }

        // Desktop/Tablet: table view
        const rows = data.map((c,i)=>{
          const vb = Number(c.volumeBase||0);
          const vq = Number(c.volumeQuote||0);
          const wb = Math.max(2, Math.round((vb/maxBase)*100));
          const wq = Math.max(2, Math.round((vq/maxQuote)*100));
          return `<tr class="odd:bg-slate-800/40 even:bg-transparent">
            <td class="px-2 py-2 text-slate-400">${i+1}</td>
            <td class="px-2 py-2"><span class="pill">${c.symbol}</span></td>
            <td class="px-2 py-2 text-right">
              <div class="bar"><div style="width:${wb}%"></div></div>
              <div>${(vb).toLocaleString('en-US')}</div>
            </td>
            <td class="px-2 py-2 text-right">
              <div class="bar"><div style="width:${wq}%"></div></div>
              <div>${fmtMoney(vq)}</div>
            </td>
            <td class="px-2 py-2 text-right ${c.change24h>=0?'text-green-400':'text-red-400'}">${pct(c.change24h)}</td>
          </tr>`;
        }).join('');

        el.toolsContent.innerHTML = `
          <div class="mb-2 text-slate-300">–†–µ–π—Ç–∏–Ω–≥ –ø–æ 24—á –æ–±—ä—ë–º—É</div>
          <div class="scroll-area" style="max-height: 396px; overflow-y:auto;">
            <table style="table-layout:fixed; width:100%;">
              <colgroup>
                <col style="width:40px;">
                <col style="width:110px;">
                <col style="width:160px;">
                <col style="width:160px;">
                <col style="width:auto;">
              </colgroup>
              <thead style="position:sticky; top:0; background:rgba(15,23,42,.9);">
                <tr>
                  <th class="text-left px-2 py-2">#</th>
                  <th class="text-left px-2 py-2">–ü–∞—Ä–∞</th>
                  <th class="text-right px-2 py-2">–û–±—ä—ë–º (base)</th>
                  <th class="text-right px-2 py-2">–û–±—ä—ë–º (USDT)</th>
                  <th class="text-right px-2 py-2">–ò–∑–º. 24—á</th>
                </tr>
              </thead>
              <tbody class="font-mono text-sm">
                ${rows}
              </tbody>
            </table>
          </div>`;
      }
          function renderToolListings(){
        el.toolsContent.innerHTML = `
          <div class="mb-2 text-slate-300">–ù–æ–≤—ã–µ –ª–∏—Å—Ç–∏–Ω–≥–∏ USDT‚ÄëPERP (Binance Futures)</div>
          <div class="mb-2 flex flex-wrap items-center gap-2">
            <input id="annQ" class="input w-44" placeholder="–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ (–Ω–∞–ø—Ä., BTC)" />
            <button id="btnAnnByBase" class="btn">–ê–Ω–æ–Ω—Å—ã (–ø–æ –±–∞–∑–µ)</button>
            <button id="btnAnnAll" class="btn">–í—Å–µ –∞–Ω–æ–Ω—Å—ã</button>
          </div>
          <div class="scroll-area" style="max-height: 264px; overflow-y:auto;">
            <table>
              <thead><tr><th>–ü–∞—Ä–∞</th><th>–î–æ–±–∞–≤–ª–µ–Ω</th><th>–ë–∞–∑–∞</th></tr></thead>
              <tbody id="listingsBody"><tr><td colspan="3" class="text-slate-400">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</td></tr></tbody>
            </table>
          </div>`;
        (async()=>{
          try{
            const ex=await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo').then(r=>r.json());
            const list=(ex.symbols||[]).filter(s=>s.status==='TRADING'&&s.quoteAsset==='USDT'&&s.contractType==='PERPETUAL'&&s.onboardDate).sort((a,b)=>b.onboardDate-a.onboardDate);
            document.getElementById('annQ').value = (state.map[state.selected]?.base)||'';
            document.getElementById('btnAnnByBase').onclick=()=>{
              const q=(document.getElementById('annQ').value||'').trim()||((state.map[state.selected]?.base)||'');
              window.open(`https://www.google.com/search?q=${encodeURIComponent(q+' binance announcement futures perpetual')}`,'_blank','noopener');
            };
            document.getElementById('btnAnnAll').onclick=()=>{
              window.open(`https://www.google.com/search?q=${encodeURIComponent('binance announcement futures perpetual')}`,'_blank','noopener');
            };
            const rows=list.map(s=>`<tr><td><span class="pill">${s.symbol}</span></td><td>${new Date(s.onboardDate).toLocaleString()}</td><td>${s.baseAsset}</td></tr>`).join('');
            document.getElementById('listingsBody').innerHTML = rows || '<tr><td colspan="3" class="text-slate-400">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</td></tr>';
          }catch(e){ document.getElementById('listingsBody').innerHTML='<tr><td colspan="3" class="text-red-400">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>'; }
        })();
      }

      async function renderToolSignals(){
        const sym=state.selected;
        el.toolsContent.innerHTML = `
          <div class="mb-2 flex flex-wrap items-center gap-2">
            <span class="text-slate-300">–°–∏–≥–Ω–∞–ª—ã –¥–ª—è</span>
            <input id="sigSearch" class="input w-44" style="color:#000;background:#fff" value="${sym}" placeholder="BTC / BTCUSDT"/>
            <button id="sigFind" class="btn">–ù–∞–π—Ç–∏</button>
            <span id="sigErr" class="text-red-400 text-sm" style="display:none">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</span>
          </div>
          <div id="sigTableWrap" class="text-slate-400">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</div>`;
        (function(){
          const inp=document.getElementById('sigSearch'), btn=document.getElementById('sigFind'), err=document.getElementById('sigErr');
          const clearErr=()=>{err.style.display='none'; inp.style.borderColor='';};
          const doFind=()=>{
            clearErr(); const q=(inp.value||'').trim().toUpperCase(); if(!q) return;
            if(state.map[q]){ state.selected=q; renderHeader(); renderTV(q); renderTool('signals'); renderScreener(); return; }
            const found=state.list.find(s => (state.map[s]?.base||'').toUpperCase()===q || s.includes(q));
            if(found){ state.selected=found; renderHeader(); renderTV(found); renderTool('signals'); renderScreener(); } else { err.style.display='inline'; inp.style.borderColor='#ef4444'; }
          };
          btn.onclick=doFind; inp.onkeypress=(e)=>{ if(e.key==='Enter') doFind(); }; inp.oninput=clearErr;
        })();

        // build table
        const cfg=state.params.signals, tfs=cfg.tfs;
        function sma(a,q){const t=a.slice(-q);return t.reduce((x,y)=>x+y,0)/(t.length||1);}
        function emaSeries(v,k){let e=v[0];for(let i=1;i<v.length;i++)e=v[i]*k+e*(1-k);return e;}
        function macdFinal(a,fa,sl,sg){function ser(v,p){const k=2/(p+1);let e=v[0],o=[e];for(let i=1;i<v.length;i++){e=v[i]*k+e*(1-k);o.push(e);}return o;} const ef=ser(a,fa),es=ser(a,sl); const m=ef.map((v,i)=>v-es[i]); const s=ser(m,sg); return {hist:m.at(-1)-s.at(-1)};}
        function rsi(a,p){let g=0,l=0;for(let i=1;i<=p;i++){const c=a[i]-a[i-1]; if(c>=0) g+=c; else l-=c;} for(let i=p+1;i<a.length;i++){const c=a[i]-a[i-1]; g=(g*(p-1)+(c>0?c:0))/p; l=(l*(p-1)+(c<0?-c:0))/p;} const rs=g/(l||1e-9); return 100-100/(1+rs);}

        const results=[];
        for(const tf of tfs){
          try{
            const kl=await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym}&interval=${tf}&limit=300`).then(r=>r.json());
            const closes=kl.map(k=>+k[4]); const last=closes.at(-1); const ma=sma(closes,cfg.ma); const ema=emaSeries(closes,2/(cfg.ema+1)); const macd=macdFinal(closes,cfg.macd.fast,cfg.macd.slow,cfg.macd.sig); const r=rsi(closes,cfg.rsi);
            const trend = last>ma && last>ema ? 'up' : (last<ma && last<ema ? 'down' : 'range');
            results.push({tf,ma,ema,macd,r,trend});
          }catch(e){ results.push({tf,error:true}); }
        }
        const rows=results.map(r=>{
          if(r.error) return `<tr><td>${r.tf}</td><td colspan="4" class="text-red-400">–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
          const tr=r.trend==='up'?'<span class="text-green-400">‚Üë –¢—Ä–µ–Ω–¥</span>':(r.trend==='down'?'<span class="text-red-400">‚Üì –¢—Ä–µ–Ω–¥</span>':'<span class="text-slate-400">–§–ª–µ—Ç</span>');
          const mac = r.macd.hist>0?'<span class="text-green-400">MACD+</span>':'<span class="text-red-400">MACD-</span>';
          const rsiTxt = r.r>70?'<span class="text-red-400">RSI 70+</span>':(r.r<30?'<span class="text-green-400">RSI 30-</span>':'<span class="text-slate-400">RSI</span>');
          return `<tr><td>${r.tf}</td><td>${tr}</td><td>${mac}</td><td>${rsiTxt} <span class="text-slate-400">(${n2(r.r)})</span></td><td class="text-right text-slate-400">MA ${n2(r.ma)} / EMA ${n2(r.ema)}</td></tr>`;
        }).join('');
        document.getElementById('sigTableWrap').innerHTML = `<table><thead><tr><th>TF</th><th>Trend MA50/EMA200</th><th>MACD</th><th>RSI(14)</th><th class="text-right">MA –¥–µ—Ç–∞–ª–∏</th></tr></thead><tbody>${rows}</tbody></table>`;
      }

      function renderToolNews(){
        const c=state.map[state.selected], base=c?c.base:''; const q=encodeURIComponent(base+' crypto');
        el.toolsContent.innerHTML = `<div class="text-slate-300 mb-3">–ù–æ–≤–æ—Å—Ç–∏ –ø–æ: <strong>${base||state.selected||''}</strong></div>
          <div class="flex flex-wrap gap-2 mb-2">
            <a class="btn" target="_blank" rel="noopener" href="https://www.google.com/search?q=${q}+site:coindesk.com&tbm=nws">CoinDesk</a>
            <a class="btn" target="_blank" rel="noopener" href="https://www.google.com/search?q=${q}+site:cointelegraph.com&tbm=nws">Cointelegraph</a>
            <a class="btn" target="_blank" rel="noopener" href="https://www.google.com/search?q=${q}+site:decrypt.co&tbm=nws">Decrypt</a>
            <a class="btn" target="_blank" rel="noopener" href="https://www.google.com/search?q=${q}+site:binance.com+announcement&tbm=nws">Binance Announcements</a>
            <a class="btn" target="_blank" rel="noopener" href="https://www.google.com/search?q=${q}+site:x.com">X (Twitter)</a>
          </div>`;
      }

      function bindTools(){
        const btns=document.querySelectorAll('.tools-btn');
        btns.forEach(b=>b.onclick=()=>{ btns.forEach(x=>x.classList.remove('active')); b.classList.add('active'); state.activeTool=b.getAttribute('data-tool'); renderTool(state.activeTool); });
        (btns[0]||{}).classList.add('active');
      }

      (async function init(){
        bindTools(); renderStatus();
        try{ await loadMarkets(); renderHeader(); renderScreener(); renderTV(state.selected); startWS(); renderTool(state.activeTool); }
        catch(e){ el.status.innerHTML='<span class="text-red-400">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Binance Futures</span>'; }
      })();

      el.search.onkeypress=(e)=>{ if(e.key==='Enter') applySearch(); };
      el.searchBtn.onclick=applySearch;
      el.clear.onclick=()=>{ el.search.value=''; state.search=''; el.hint.textContent=''; renderScreener(); renderTool(state.activeTool); };
      el.toggle.onclick=()=>{ state.showPrices=!state.showPrices; el.toggle.textContent=state.showPrices?'üôà –°–∫—Ä—ã—Ç—å —Ü–µ–Ω—ã':'üëÅ –ü–æ–∫–∞–∑–∞—Ç—å —Ü–µ–Ω—ã'; renderHeader(); renderScreener(); renderTool(state.activeTool); };
      el.gainers.onclick=()=>{ state.screenerView='gainers'; el.gainers.className='btn flex-1 text-white bg-green-600/80 border-green-700'; el.losers.className='btn flex-1 text-white'; renderScreener(); renderTool(state.activeTool); };
      el.losers.onclick=()=>{ state.screenerView='losers'; el.losers.className='btn flex-1 text-white bg-red-600/80 border-red-700'; el.gainers.className='btn flex-1 text-white'; renderScreener(); renderTool(state.activeTool); };
      new ResizeObserver(()=>enforceViewportRows()).observe(el.screener);
    </script>
  </body>
</html>
