<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
    <meta name="color-scheme" content="dark light" />
    <meta name="theme-color" content="#0f172a" />
    <link rel="manifest" href="./manifest.json">
    <title>Crypto Run Tracker ‚Äî Binance Futures</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://s3.tradingview.com" crossorigin>
    <link rel="preconnect" href="https://fapi.binance.com" crossorigin>
    <link rel="preconnect" href="https://fstream.binance.com" crossorigin>
    <style>
w2px; overflow-y:auto;}

      :root{--bg:#0f172a;--pane:#1f2937;--br:#334155;}
      body{background:radial-gradient(100% 100% at 50% 0%, #1e1b4b 0%, #0f172a 60%, #0f172a 100%);color:#e5e7eb}
      .card{background:rgba(30,41,59,.5);backdrop-filter:blur(6px);border:1px solid #334155;border-radius:1rem}
      .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.55rem 1rem;border-radius:.8rem;border:1px solid #475569;background:rgba(51,65,85,.5);min-height:44px}
      .btn:hover{background:rgba(51,65,85,.8)}
      .pill{padding:.15rem .5rem;border-radius:.5rem;border:1px solid #475569}
      .scroll-area{scrollbar-width:thin;scrollbar-color:#475569 transparent}
      .scroll-area::-webkit-scrollbar{width:8px}.scroll-area::-webkit-scrollbar-thumb{background:#475569;border-radius:8px}
      #tv-container{width:100%;height:560px}@media(max-width:1024px){#tv-container{height:440px}}@media(max-width:640px){#tv-container{height:380px}}
      .tools-btn{font-size:.95rem;padding:.45rem .8rem;border-radius:.6rem;border:1px solid #475569;background:rgba(51,65,85,.5)}
      .tools-btn.active{border-color:#7c3aed;background:rgba(124,58,237,.18)}
          .bar{height:10px;background:rgba(148,163,184,.25);border-radius:4px;overflow:hidden}
      .bar>div{height:100%;background:rgba(124,58,237,.7)}
      td .bar{max-width:100%;}
          .col-right{display:flex;flex-direction:column}
      .col-right>.card:last-child{flex:1;display:flex;flex-direction:column}
      .col-right>.card:last-child>#toolsContent{flex:1;}
    </style>
  
<style id="anom-neutral-override">
#anomListWrap table tbody tr { background: transparent !important; }
#anomListWrap .text-green, #anomListWrap .text-red,
#anomListWrap .text-green-400, #anomListWrap .text-red-400,
#anomListWrap .text-green-500, #anomListWrap .text-red-500,
#anomListWrap .text-green-600, #anomListWrap .text-red-600 {
  color: #cbd5e1 !important;
}
</style>

<style>z8px;overflow-y:auto;}</style></head>
  <body>
    <div class="min-h-screen">
      <div class="container mx-auto px-3 sm:px-4 py-4 sm:py-6">
        <div class="text-center mb-4 sm:mb-6">
          <h1 class="text-2xl sm:text-3xl font-bold">Crypto Run Tracker</h1>
        </div>

        <div class="card p-3 sm:p-4 mb-4 sm:mb-6">
          <div class="flex flex-col lg:flex-row gap-3 items-stretch lg:items-center justify-between">
            <div class="relative flex-1 w-full flex gap-2">
              <div class="relative flex-1">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 select-none">üîé</span>
                <input id="searchInput" class="w-full pl-10 pr-10 py-2 bg-slate-700/50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="–ü–æ–∏—Å–∫: BTC / BTCUSDT" />
                <button id="clearSearch" title="–û—á–∏—Å—Ç–∏—Ç—å" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-200">‚úï</button>
              </div>
              <button id="searchBtn" class="btn text-white" type="button">–ù–∞–π—Ç–∏</button>
            </div>
            <div class="flex items-center gap-2">
              <span class="hidden sm:inline pill" id="marketInfo">–ü–∞—Ä—ã: ‚Äî</span>
              <button id="togglePricesBtn" class="btn text-white" type="button">üôà –°–∫—Ä—ã—Ç—å —Ü–µ–Ω—ã</button>
            </div>
          </div>
          <div id="statusBar" class="mt-2 text-xs text-slate-300"></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6 items-stretch" style="min-height: 720px;">
          <div class="lg:col-span-1 card p-4 flex flex-col">
            <div class="mb-3">
              <h2 class="text-xl font-bold">–¢–æ–ø —Ñ—å—é—á–µ—Ä—Å–æ–≤ (USDT‚ÄëPERP)</h2>
              <div id="filterHint" class="text-xs text-slate-400"></div>
            </div>
            <div class="flex gap-2 mb-3">
              <button id="btnGainers" class="btn flex-1 text-white bg-green-600/80 border-green-700" type="button">üìà –†–æ—Å—Ç</button>
              <button id="btnLosers" class="btn flex-1 text-white" type="button">üìâ –ü–∞–¥–µ–Ω–∏–µ</button>
            </div>
            <div id="screenerList" class="scroll-area overflow-y-auto"></div>
<div id="oiFloat" class="mt-3 hidden rounded-xl border border-slate-700 p-3 bg-slate-900/70 backdrop-blur-md">
  <div class="flex items-center justify-between mb-2">
    <div class="flex items-center gap-2">
      <span class="text-slate-300 text-sm">Open Interest</span>
      <span id="oiF_sym" class="pill">‚Äî</span>
    </div>
    <div class="flex gap-1">
      <button id="oiP_1m" class="tools-btn" type="button">1–º</button>
      <button id="oiP_5m" class="tools-btn active" type="button">5–º</button>
      <button id="oiP_15m" class="tools-btn" type="button">15–º</button>
    </div>
    <button id="oiF_close" class="tools-btn" type="button" title="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
  </div>
  <div class="grid grid-cols-2 gap-3 font-mono text-sm">
    <div>
      <div class="text-slate-400 text-xs" id="oiF_buyLbl">Taker Buy (5m)</div>
      <div><span id="oiF_buy" class="text-green-400">‚Äî</span> <span id="oiF_buyPct" class="text-green-300 text-xs"> </span></div>
    </div>
    <div>
      <div class="text-slate-400 text-xs" id="oiF_sellLbl">Taker Sell (5m)</div>
      <div><span id="oiF_sell" class="text-red-400">‚Äî</span> <span id="oiF_sellPct" class="text-red-300 text-xs"> </span></div>
    </div>
    <div>
      <div class="text-slate-400 text-xs">Open Interest (now)</div>
      <div id="oiF_now">‚Äî</div>
    </div>
    <div>
      <div class="text-slate-400 text-xs">Œî OI vs prev</div>
      <div id="oiF_delta">‚Äî</div>
    </div>
    <div class="col-span-2">
      <div class="text-slate-400 text-xs">–í—Å–µ–≥–æ (Buy+Sell, 5m)</div>
      <div id="oiF_total">‚Äî</div>
    </div>
  </div>
  <div class="text-xs text-slate-400 mt-2" id="oiF_ts">‚Äî</div>
</div>
          </div>

          <div class="lg:col-span-2 space-y-4 col-right">
            <div class="card p-4">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div id="assetAvatar" class="w-10 h-10 rounded-full bg-slate-700 grid place-items-center text-white font-bold">‚Äî</div>
                  <div><h3 id="assetName" class="font-semibold text-lg">‚Äî</h3><p id="assetSymbol" class="text-slate-400 text-sm">‚Äî</p></div>
                </div>
                <div class="text-right">
                  <div id="assetPrice" class="font-mono text-xl">‚Ä¶</div>
                  <div id="assetChange" class="text-sm font-semibold">‚Äî</div>
                </div>
              </div>
            </div>

            <div class="card p-0 overflow-hidden"><div id="tv-container"></div></div>

            <div class="card">
              <div class="sticky top-0 p-2 border-b border-slate-700 bg-slate-900/60 backdrop-blur-sm rounded-t-xl flex gap-2 flex-wrap">
                <button class="tools-btn" data-tool="volumes">–û–±—ä—ë–º—ã</button>
                <button class="tools-btn" data-tool="listings">–õ–∏—Å—Ç–∏–Ω–≥–∏</button>
                <button class="tools-btn" data-tool="signals">–°–∏–≥–Ω–∞–ª—ã</button>
                <button class="tools-btn" data-tool="news">–ù–æ–≤–æ—Å—Ç–∏</button>
              </div>
              <div id="toolsContent" class="p-3"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js');

      const fmtMoney = (v) => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:v<1?4:2,maximumFractionDigits:v<1?6:2}).format(v);
      const n2=(v)=>Number(v).toFixed(2); const pct=(v)=> isFinite(v)?((v>=0?'+':'')+Number(v).toFixed(2)+'%'):'‚Äî';

      const state = {
        map:{}, list:[], selected:null,
        showPrices:true, screenerView:'gainers', search:'',
        prevVisibleSet:new Set(), wsConnected:false,
        activeTool:'volumes',
        oiPeriod:'5m',
        params:{ signals:{ rsi:14, ma:50, ema:200, macd:{fast:12,slow:26,sig:9}, tfs:['5m','15m','1h','4h'] } }
      };

      const el={
        search:document.getElementById('searchInput'),
        clear:document.getElementById('clearSearch'),
        searchBtn:document.getElementById('searchBtn'),
        toggle:document.getElementById('togglePricesBtn'),
        gainers:document.getElementById('btnGainers'),
        losers:document.getElementById('btnLosers'),
        screener:document.getElementById('screenerList'),
        status:document.getElementById('statusBar'),
        hint:document.getElementById('filterHint'),
        marketInfo:document.getElementById('marketInfo'),
        toolsContent:document.getElementById('toolsContent'),
      };

      function enforceViewportRows(){
        const r = el.screener.querySelector('.row-crypto');
        const h = r ? r.getBoundingClientRect().height : 64;
        const isMobile = window.matchMedia('(max-width: 767px)').matches;
        const rows = isMobile ? 5 : 13;
        el.screener.style.maxHeight = (h*rows) + 'px';
      }

      function renderStatus(){
        const count = state.list.length;
        el.status.innerHTML = `<span class="${state.wsConnected?'text-green-400':'text-red-400'}">WS: ${state.wsConnected?'–ø–æ–¥–∫–ª—é—á–µ–Ω–æ':'–Ω–µ—Ç'}</span> <span class="ml-2 text-slate-400">–ü–∞—Ä—ã: ${count||'‚Äî'}</span>`;
        if (el.marketInfo) el.marketInfo.textContent='–ü–∞—Ä—ã: '+(count||'‚Äî');
      }

      let tvWidget=null;
      function ensureTV(cb){
        if (window.TradingView && window.TradingView.widget) return cb();
        if (document.getElementById('tvjs')) return setTimeout(cb,120);
        const s=document.createElement('script'); s.id='tvjs'; s.src='https://s3.tradingview.com/tv.js'; s.onload=cb; document.body.appendChild(s);
      }
      function renderTV(symbol){
        ensureTV(()=>{
          if (!window.TradingView) return;
          if (tvWidget && tvWidget.remove) try{tvWidget.remove();}catch(e){}
          tvWidget = new window.TradingView.widget({
            autosize:true, symbol:'BINANCE:'+symbol+'.P', interval:'60', theme:'dark', style:'1', locale:'en',
            container_id:'tv-container', hide_top_toolbar:false, hide_side_toolbar:false, toolbar_bg:'#0f172a', withdateranges:true, details:true, hotlist:true, calendar:true,
            overrides:{'paneProperties.background':'#0f172a','paneProperties.vertGridProperties.color':'#374151','paneProperties.horzGridProperties.color':'#374151'}
          });
        });
      }

      async function loadMarkets(){
        const ex = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo').then(r=>r.json());
        const usdt = ex.symbols.filter(s=>s.status==='TRADING' && s.quoteAsset==='USDT' && s.contractType==='PERPETUAL')
          .map(s=>({symbol:s.symbol, base:s.baseAsset, quote:s.quoteAsset, onboard:s.onboardDate}));
        const t = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json());
        const mapT=Object.fromEntries(t.map(x=>[x.symbol,x]));
        state.map={}; state.list=[];
        for (const s of usdt){
          const tt=mapT[s.symbol]; if(!tt) continue;
          state.map[s.symbol]={...s, price:+tt.lastPrice, change24h:+tt.priceChangePercent, volumeQuote:+tt.quoteVolume, volumeBase:+tt.volume, high:+tt.highPrice, low:+tt.lowPrice};
          state.list.push(s.symbol);
        }
        state.list.sort((a,b)=> (state.map[b].volumeQuote||0)-(state.map[a].volumeQuote||0));
        state.selected = state.list[0]||'BTCUSDT';
      }

      
// === Funding rates (Binance Futures) ===
let fundingMap = Object.create(null);
let fundingTS = 0;
async function fetchFundingAll(){
  const base = `https://fapi.binance.com/fapi/v1/premiumIndex`;
  const ways = [
    base,
    `https://cors.isomorphic-git.org/${base}`,
    `https://r.jina.ai/http://fapi.binance.com/fapi/v1/premiumIndex`,
    `https://corsproxy.io/?${encodeURIComponent(base)}`
  ];
  let lastErr=null;
  for(const u of ways){
    try{
      const r = await fetch(u,{cache:'no-store'});
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const j = await r.json();
      if(Array.isArray(j)){
        const m = Object.create(null);
        for(const it of j){
          if(!it || !it.symbol) continue;
          const sym = it.symbol;
          let fr = null;
          if (it.lastFundingRate!=null) fr = Number(it.lastFundingRate)*100;
          else if (it.fundingRate!=null) fr = Number(it.fundingRate)*100;
          if (isFinite(fr)) m[sym] = fr;
        }
        fundingMap = m; fundingTS = Date.now();
        return m;
      }
    }catch(e){ lastErr=e; }
  }
  console.warn('Funding fetch failed', lastErr);
  return fundingMap;
}
function fmtFunding(v){
  if (v==null || !isFinite(v)) return '‚Äî';
  const s = (v>=0?'+':'') + v.toFixed(3) + '%';
  return s;
}
async function ensureFundingFresh(){
  const staleMs = 5*60*1000;
  if (Date.now() - fundingTS > staleMs) await fetchFundingAll();
}
setInterval(fetchFundingAll, 5*60*1000);
fetchFundingAll();

function startWS(){
        const ws = new WebSocket('wss://fstream.binance.com/stream?streams=!ticker@arr');
        ws.onopen=()=>{state.wsConnected=true; renderStatus();};
        ws.onmessage=(e)=>{
          const msg=JSON.parse(e.data); const arr=msg && msg.data; if(!Array.isArray(arr)) return;
          for(const t of arr){ const s=t.s; const e=state.map[s]; if(!e) continue; e.price=+t.c; e.change24h=+t.P; e.volumeQuote=+t.q; e.volumeBase=+t.v; }
          renderHeader(); maybeRenderScreener(); if(state.activeTool==='volumes') renderTool('volumes');
        };
        ws.onclose=()=>{state.wsConnected=false; renderStatus(); setTimeout(startWS,1500);};
        ws.onerror=()=>{state.wsConnected=false; renderStatus();};
      }

      function renderHeader(){
        const c=state.map[state.selected]; if(!c) return;
        document.getElementById('assetAvatar').textContent=(c.base||'?').slice(0,3);
        document.getElementById('assetName').textContent=c.base+' PERP';
        document.getElementById('assetSymbol').textContent=c.symbol+' (Futures)';
        document.getElementById('assetPrice').textContent=c.price!=null ? (state.showPrices?fmtMoney(c.price):'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'):'‚Ä¶';
        const ch=Number(c.change24h), elC=document.getElementById('assetChange');
        if(isFinite(ch)){ elC.textContent=`${ch>=0?'+':''}${ch.toFixed(2)}% 24h`; elC.className=`text-sm font-semibold ${ch>=0?'text-green-400':'text-red-400'}`;}
        else { elC.textContent='‚Äî'; elC.className='text-sm font-semibold text-slate-400'; }
      }

      function filteredSymbols(){
        const q=state.search.trim().toLowerCase(); if(!q) return state.list;
        return state.list.filter(sym=>{
          const e=state.map[sym]; return e.symbol.toLowerCase().includes(q) || e.base.toLowerCase().includes(q);
        });
      }
      function screenerOrder(list){
        const entries=list.map(sym=>state.map[sym]).filter(Boolean);
        return (state.screenerView==='gainers') ? entries.sort((a,b)=> (b.change24h)-(a.change24h)) : entries.sort((a,b)=> (a.change24h)-(b.change24h));
      }
      async function renderScreener(){
        await ensureFundingFresh(); const q=state.search.trim(); const pool=filteredSymbols(); let entries=screenerOrder(pool); let hint='';
        if(q && pool.length===0){ entries=screenerOrder(state.list); hint=`–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ ‚Äú${q}‚Äù. –ü–æ–∫–∞–∑–∞–Ω –æ–±—â–∏–π —Ç–æ–ø.`; }
        el.hint.textContent=hint;
        const visible=entries.slice(0,13).map(c=>c.symbol); state.prevVisibleSet=new Set(visible);
        const rows=entries.map((c,idx)=>{
          const isSel=c.symbol===state.selected;
          const change=c.change24h, cls=isFinite(change)?(change>=0?'text-green-400':'text-red-400'):'text-slate-400';
          const priceText=c.price!=null?(state.showPrices?fmtMoney(c.price):'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'):'‚Ä¶';
          return `<div class="row-crypto p-3 rounded-lg cursor-pointer transition-all ${isSel?'bg-slate-700 border border-purple-500':'bg-slate-700/30 hover:bg-slate-700/50'}" data-sym="${c.symbol}">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-slate-700 grid place-items-center text-xs font-bold">${c.base.slice(0,3)}</div>
                <div><div class="font-semibold text-sm">${c.base} PERP</div><div class="text-slate-400 text-xs">${c.symbol}</div></div>
              </div>
              <div class="text-right">
                <div class="text-xs opacity-80 mt-0.5">${fmtFunding(fundingMap[c.symbol])}</div>

                <div class="font-mono text-sm">${priceText}</div>
                <div class="text-xs font-semibold ${cls}">${isFinite(change)?(change>=0?'+':'')+change.toFixed(2)+'%':'‚Äî'}</div>
              </div>
            </div></div>`;
        }).join('');
        el.screener.innerHTML = rows || '<div class="text-slate-400 text-sm">–î–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç‚Ä¶</div>';
        el.screener.querySelectorAll('[data-sym]').forEach(n=> n.onclick=()=>{ const s=n.getAttribute('data-sym'); if(state.map[s]){ state.selected=s; renderHeader(); renderTV(s); renderScreener(); renderTool(state.activeTool); OI_updateFloat(s); }});
        enforceViewportRows();
      }
      function maybeRenderScreener(){ renderScreener(); }

      function applySearch(){
        state.search=el.search.value||'';
        const m=filteredSymbols();
        if(state.search.trim() && m.length>0){ const first=m[0]; if(first && first!==state.selected){ state.selected=first; renderHeader(); renderTV(first);} }
        renderScreener(); if(state.activeTool) renderTool(state.activeTool);
      }

      function renderTool(mode){
        if(mode==='volumes') return renderToolVolumes();
        if(mode==='listings') return renderToolListings();
        if(mode==='signals') return renderToolSignals();
        if(mode==='news') return renderToolNews();
      }

      
      
      
  
  
  
  
  
  function renderToolVolumes(){
    const isMobile = window.matchMedia('(max-width: 767px)').matches;

    // ---------- –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (—Å–æ–∑–¥–∞—ë–º –æ–¥–∏–Ω —Ä–∞–∑) ----------
    let root = document.getElementById('volumesRoot');
    if (!root) {
      el.toolsContent.innerHTML = `
        <div id="volumesRoot">
          <div class="mb-3 flex flex-wrap items-center gap-2">
            <span class="text-slate-300">Futures (Binance) ‚Äî 24—á –¥–∞–Ω–Ω—ã–µ –ø–æ —Ç–∏–∫–µ—Ä—É</span>
            <input id="volQ" class="input w-56" style="color:#000;background:#fff" placeholder="BTC / BTCUSDT" autocomplete="off"/>
            <button id="volFind" class="btn" type="button">–ù–∞–π—Ç–∏</button>
            <span id="volErr" class="text-red-400 text-sm" style="display:none"></span>
          </div>
          <div id="volResult" class="mb-4"></div>
<!-- === –°–æ–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞ (FORCE) ‚Äî –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –ø–æ–∏—Å–∫ –≤–Ω—É—Ç—Ä–∏ –ø–∞–Ω–µ–ª–∏ === -->
<div id="agentPanel" style="border:1px solid #1f2937;background:rgba(15,23,42,.6);border-radius:16px;padding:12px;margin-top:12px;max-width:1024px;margin-left:auto;margin-right:auto;">
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
    <div style="color:#e2e8f0;font-weight:700;">–°–æ–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞</div>
    <input id="agentSearchInput" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: BTC –∏–ª–∏ BTCUSDT" style="flex:1 1 220px;min-width:220px;border-radius:12px;background:rgba(2,6,23,.5);border:1px solid #334155;padding:8px 12px;color:white;">
    <button id="agentSearchBtn" type="button" onclick="agent_panel_run()" style="background:#0ea5e9;color:white;border-radius:12px;padding:8px 14px;font-weight:600;">–ù–∞–π—Ç–∏</button>
  </div>
  <div id="agentOut" style="color:#94a3b8;font-size:14px;margin-top:8px;">–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–∞–π—Ç–∏¬ª ‚Äî –ø–æ–ª—É—á–∏—Ç–µ –õ–û–ù–ì/–®–û–†–¢, Entry/SL/TP, RR, ATR –∏ –ø—Ä–∏—á–∏–Ω—ã.</div>
</div>

          <div class="mb-2 text-slate-300">–†–µ–π—Ç–∏–Ω–≥ –ø–æ 24—á –æ–±—ä—ë–º—É (Futures)</div>
          <div id="volumesTableWrap" class="scroll-area" style="max-height: 396px; overflow-y:auto;"></div>
        </div>
      `;
      root = document.getElementById('volumesRoot');
    }

    const qInput = document.getElementById('volQ');
    const findBtn = document.getElementById('volFind');
    const errLbl  = document.getElementById('volErr');
    const resBox  = document.getElementById('volResult');
    const tableWrap = document.getElementById('volumesTableWrap');

    // ---------- "–ª–∏–ø–∫–æ–µ" –∑–Ω–∞—á–µ–Ω–∏–µ –∏–Ω–ø—É—Ç–∞ ----------
    // –•—Ä–∞–Ω–∏–º —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å –≤ state.volumesQuery; –Ω–µ –ø–µ—Ä–µ–∑–∞—Ç–∏—Ä–∞–µ–º –ø–æ–ª–µ –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Ä–µ–Ω–¥–µ—Ä–∞—Ö.
    if (typeof state.volumesQuery !== 'string') {
      state.volumesQuery = (state?.map?.[state?.selected]?.symbol) || (state?.map?.[state?.selected]?.base) || '';
    }
    if (qInput.value !== state.volumesQuery) {
      qInput.value = state.volumesQuery;
    }
    qInput.style.setProperty('color','#000','important');
    qInput.addEventListener('input', ()=>{
      state.volumesQuery = qInput.value;
      qInput.style.setProperty('color','#000','important');
    });
    qInput.addEventListener('focus', ()=>{
      qInput.style.setProperty('color','#000','important');
    });
    qInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); doFind(); } });

    function fmtTs(ts){ try{ return new Date(Number(ts)).toLocaleString(); }catch(_){ return '‚Äî'; } }
    function safe(v, digits=2){ const n=Number(v); return Number.isFinite(n)? n.toFixed(digits):'‚Äî'; }
    function money(v){ const n=Number(v); return Number.isFinite(n)? fmtMoney(n):'‚Äî'; }
    function setErr(msg){ errLbl.textContent = msg || '–¢–∏–∫–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω (Futures)'; errLbl.style.display='inline'; }
    function clearErr(){ errLbl.style.display='none'; errLbl.textContent=''; }
    function busy(b){ findBtn.disabled = b; findBtn.setAttribute('aria-busy', b?'true':'false'); }

    async function binanceFetch(url){
      const r = await fetch(url, {cache:'no-store'});
      if(!r.ok){
        const txt = await r.text().catch(()=>'');
        const e = new Error('HTTP ' + r.status);
        e.status = r.status; e.body = txt;
        throw e;
      }
      return r.json();
    }

    async function resolveSymbolFutures(q){
      if (state?.map?.[q]) return q;
      const local = state?.list?.find(s => (state.map[s]?.base||'').toUpperCase() === q || s.includes(q));
      if (local) return local;
      try{
        const info = await binanceFetch('https://fapi.binance.com/fapi/v1/exchangeInfo');
        const bySym = info.symbols?.find(s => s.symbol === q);
        if (bySym) return bySym.symbol;
        const byBase = info.symbols?.find(s => s.baseAsset === q && s.quoteAsset === 'USDT');
        if (byBase) return byBase.symbol;
      }catch(_){}
      return null;
    }

    async function fetch24hrFutures(sym){
      return binanceFetch('https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=' + encodeURIComponent(sym));
    }

    async function lookupAndRender(symbolOrBase){
      clearErr();
      resBox.innerHTML = '';

      const raw = (symbolOrBase ?? state.volumesQuery ?? '').trim();
      const q = raw.toUpperCase();
      state.volumesQuery = q; // –∑–∞–ø–æ–º–∏–Ω–∞–µ–º
      qInput.value = q;
      qInput.style.setProperty('color','#000','important');
      if(!q){ setErr('–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä —Ñ—å—é—á–µ—Ä—Å–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä BTC –∏–ª–∏ BTCUSDT'); return; }

      busy(true);
      try{
        let sym = await resolveSymbolFutures(q);
        if (!sym) throw new Error('–¢–∏–∫–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Binance Futures');
        const data = await fetch24hrFutures(sym);

        // —É—Å–ø–µ—Ö: –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –≤ –ø–æ–ª–µ
        state.volumesQuery = data.symbol || sym;
        qInput.value = state.volumesQuery;
        qInput.style.setProperty('color','#000','important');

        const ch = Number(data.priceChangePercent);
        const chCls = Number.isFinite(ch) ? (ch>=0 ? 'text-green-400' : 'text-red-400') : 'text-slate-400';

        resBox.innerHTML = `
          <div class="rounded-xl border border-slate-700 p-3 bg-slate-800/40">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2">
                <span class="pill">${data.symbol || sym}</span>
                <span class="text-slate-400 text-xs">FUTURES</span>
                <span class="text-slate-400 text-sm">24—á —Å–≤–æ–¥–∫–∞</span>
              </div>
              <div class="text-right ${chCls} text-sm font-semibold">
                ${Number.isFinite(ch) ? (ch>=0?'+':'') + ch.toFixed(2) + '%' : '‚Äî'} <span class="ml-2 pill">${Number.isFinite(ch) ? (ch>0?'‚ñ≤ UP': (ch<0?'‚ñº DOWN':'‚ñ¨ FLAT')) : ''}</span>
              </div>
            
            <!-- –ú–∏–Ω–∏-—à–∫–∞–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞ 24—á -->
            ${(() => {
                if (!Number.isFinite(ch)) return '';
                const cap = 20; // –¥–∏–∞–ø–∞–∑–æ–Ω ¬±20%
                const mag = Math.min(cap, Math.abs(ch));
                const w = Math.max(2, Math.round((mag / cap) * 100));
                return `
                <div class="mb-3">
                  <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">Change (24h) ‚Äî magnitude</div>
                  <div class="bar" style="height:8px;"><div style="width:${w}%;"></div></div>
                  <div class="flex justify-between text-xs text-slate-400 mt-1">
                    <span>-20%</span><span>0%</span><span>+20%</span>
                  </div>
                </div>`;
            })()}
</div>

            <!-- –°–µ–∫—Ü–∏—è: –¶–µ–Ω—ã -->
            <div class="mb-3">
              <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">Prices</div>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 font-mono text-sm">
                <div><div class="text-slate-400">Last Price</div><div>${safe(data.lastPrice, (Number(data.lastPrice)<1?6:2))}</div></div>
                <div><div class="text-slate-400">Price Change</div><div>${safe(data.priceChange)} (${safe(data.priceChangePercent)}%)</div></div>
                <div><div class="text-slate-400">Weighted Avg</div><div>${safe(data.weightedAvgPrice)}</div></div>
                <div><div class="text-slate-400">High (24h)</div><div>${safe(data.highPrice)}</div></div>
                <div><div class="text-slate-400">Low (24h)</div><div>${safe(data.lowPrice)}</div></div>
                <div><div class="text-slate-400">Open Price</div><div>${safe(data.openPrice)}</div></div>
              </div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è: –û–±—ä—ë–º—ã —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∫–∞–∫ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ -->
            ${(() => {
                try {
                  const list = (state?.list||[]).map(s => state.map[s]).filter(Boolean);
                  const maxBase = Math.max(...list.map(c => Number(c.volumeBase||0)), 1);
                  const maxQuote = Math.max(...list.map(c => Number(c.volumeQuote||0)), 1);
                  const vb = Number(data.volume||0);
                  const vq = Number(data.quoteVolume||0);
                  const wb = Math.max(2, Math.round((vb/maxBase)*100));
                  const wq = Math.max(2, Math.round((vq/maxQuote)*100));
                  return `
                  <div class="mb-3">
                    <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">Volumes</div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                      <div>
                        <div class="text-slate-400 text-xs mb-1">–û–±—ä—ë–º (base)</div>
                        <div class="bar"><div style="width:${wb}%"></div></div>
                        <div class="font-mono text-sm mt-1">${vb.toLocaleString('en-US')}</div>
                      </div>
                      <div>
                        <div class="text-slate-400 text-xs mb-1">–û–±—ä—ë–º (USDT)</div>
                        <div class="bar"><div style="width:${wq}%"></div></div>
                        <div class="font-mono text-sm mt-1">${fmtMoney(vq)}</div>
                      </div>
                    </div>
                  </div>`;
                } catch(_){ return ''; }
              })()}

            <!-- –°–µ–∫—Ü–∏—è: –í—Ä–µ–º—è –∏ —Ç–æ—Ä–≥–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å -->
            <div class="mb-1">
              <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">Times & Activity</div>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 font-mono text-sm">
                <div><div class="text-slate-400">Open Time</div><div>${fmtTs(data.openTime)}</div></div>
                <div><div class="text-slate-400">Close Time</div><div>${fmtTs(data.closeTime)}</div></div>
                <div><div class="text-slate-400">Trades (count)</div><div>${Number(data.count||0).toLocaleString('en-US')}</div></div>
                <div><div class="text-slate-400">Last Qty</div><div>${safe(data.lastQty)}</div></div>
              </div>
            </div>
          </div>
`;
      }catch(e){
        console.error(e);
        setErr(e?.message || '–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≤–æ —Ñ—å—é—á–µ—Ä—Å–∞—Ö');
      }finally{
        busy(false);
      }
    }

    function doFind(){ lookupAndRender(qInput.value); }
    findBtn.onclick = doFind;

    // ---------- –Ω–∏–∂–Ω–∏–π –±–ª–æ–∫: —Ä–µ–π—Ç–∏–Ω–≥ –ø–æ –æ–±—ä—ë–º–∞–º (–∫–∞–∫ –µ—Å—Ç—å) ----------
    const data = (state?.list||[])
      .map(s => state.map[s])
      .filter(Boolean)
      .sort((a,b)=>(b.volumeQuote||0)-(a.volumeQuote||0))
      .slice(0,200);

    const maxBase = Math.max(...data.map(c=>Number(c.volumeBase||0)), 1);
    const maxQuote = Math.max(...data.map(c=>Number(c.volumeQuote||0)), 1);

    if (isMobile) {
      const cards = data.map((c,i)=>{
        const vb = Number(c.volumeBase||0);
        const vq = Number(c.volumeQuote||0);
        const wb = Math.max(2, Math.round((vb/maxBase)*100));
        const wq = Math.max(2, Math.round((vq/maxQuote)*100));
        const change = Number(c.change24h);
        const chClass = Number.isFinite(change) ? (change>=0?'text-green-400':'text-red-400') : 'text-slate-400';
        const chText = Number.isFinite(change) ? `${change>=0?'+':''}${change.toFixed(2)}%` : '‚Äî';
        return `<div class="rounded-xl border border-slate-700 p-3 mb-3 bg-slate-800/40">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="pill text-xs">${i+1}</span>
              <span class="pill">${c.symbol}</span>
            </div>
            <div class="text-right ${chClass} text-sm font-semibold">${chText}</div>
          </div>
          <div class="grid grid-cols-1 gap-2">
            <div>
              <div class="text-xs text-slate-400 mb-1">–û–±—ä—ë–º (base)</div>
              <div class="bar"><div style="width:${wb}%"></div></div>
              <div class="font-mono text-sm mt-1">${vb.toLocaleString('en-US')}</div>
            </div>
            <div>
              <div class="text-xs text-slate-400 mb-1">–û–±—ä—ë–º (USDT)</div>
              <div class="bar"><div style="width:${wq}%"></div></div>
              <div class="font-mono text-sm mt-1">${fmtMoney(vq)}</div>
            </div>
          </div>
        </div>`;
      }).join('');
      tableWrap.innerHTML = cards;
      return;
    }

    // Desktop/Tablet: table view
    const rows = data.map((c,i)=>{
      const vb = Number(c.volumeBase||0);
      const vq = Number(c.volumeQuote||0);
      const wb = Math.max(2, Math.round((vb/maxBase)*100));
      const wq = Math.max(2, Math.round((vq/maxQuote)*100));
      return `<tr class="odd:bg-slate-800/40 even:bg-transparent">
        <td class="px-2 py-2 text-slate-400">${i+1}</td>
        <td class="px-2 py-2"><span class="pill">${c.symbol}</span></td>
        <td class="px-2 py-2 text-right">
          <div class="bar"><div style="width:${wb}%"></div></div>
          <div>${(vb).toLocaleString('en-US')}</div>
        </td>
        <td class="px-2 py-2 text-right">
          <div class="bar"><div style="width:${wq}%"></div></div>
          <div>${fmtMoney(vq)}</div>
        </td>
        <td class="px-2 py-2 text-right ${c.change24h>=0?'text-green-400':'text-red-400'}">${pct(c.change24h)}</td>
      </tr>`;
    }).join('');

    tableWrap.innerHTML = `
      <table style="table-layout:fixed; width:100%;">
        <colgroup>
          <col style="width:40px;">
          <col style="width:110px;">
          <col style="width:160px;">
          <col style="width:160px;">
          <col style="width:auto;">
        </colgroup>
        <thead style="position:sticky; top:0; background:rgba(15,23,42,.9);">
          <tr>
            <th class="text-left px-2 py-2">#</th>
            <th class="text-left px-2 py-2">–ü–∞—Ä–∞</th>
            <th class="text-right px-2 py-2">–û–±—ä—ë–º (base)</th>
            <th class="text-right px-2 py-2">–û–±—ä—ë–º (USDT)</th>
            <th class="text-right px-2 py-2">–ò–∑–º. 24—á</th>
          </tr>
        </thead>
        <tbody class="font-mono text-sm">
          ${rows}
        </tbody>
      </table>
    `;
  }






          function renderToolListings(){
        el.toolsContent.innerHTML = `
          <div class="mb-2 text-slate-300">–ù–æ–≤—ã–µ –ª–∏—Å—Ç–∏–Ω–≥–∏ USDT‚ÄëPERP (Binance Futures)</div>
          <div class="mb-2 flex flex-wrap items-center gap-2">
            <input id="annQ" class="input w-44" placeholder="–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ (–Ω–∞–ø—Ä., BTC)" />
            <button id="btnAnnByBase" class="btn">–ê–Ω–æ–Ω—Å—ã (–ø–æ –±–∞–∑–µ)</button>
            <button id="btnAnnAll" class="btn">–í—Å–µ –∞–Ω–æ–Ω—Å—ã</button>
          </div>
          <div class="scroll-area" style="max-height: 264px; overflow-y:auto;">
            <table>
              <thead><tr><th>–ü–∞—Ä–∞</th><th>–î–æ–±–∞–≤–ª–µ–Ω</th><th>–ë–∞–∑–∞</th></tr></thead>
              <tbody id="listingsBody"><tr><td colspan="3" class="text-slate-400">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</td></tr></tbody>
            </table>
          </div>`;
        (async()=>{
          try{
            const ex=await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo').then(r=>r.json());
            const list=(ex.symbols||[]).filter(s=>s.status==='TRADING'&&s.quoteAsset==='USDT'&&s.contractType==='PERPETUAL'&&s.onboardDate).sort((a,b)=>b.onboardDate-a.onboardDate);
            document.getElementById('annQ').value = (state.map[state.selected]?.base)||'';
            document.getElementById('btnAnnByBase').onclick=()=>{
              const q=(document.getElementById('annQ').value||'').trim()||((state.map[state.selected]?.base)||'');
              window.open(`https://www.google.com/search?q=${encodeURIComponent(q+' binance announcement futures perpetual')}`,'_blank','noopener');
            };
            document.getElementById('btnAnnAll').onclick=()=>{
              window.open(`https://www.google.com/search?q=${encodeURIComponent('binance announcement futures perpetual')}`,'_blank','noopener');
            };
            const rows=list.map(s=>`<tr><td><span class="pill">${s.symbol}</span></td><td>${new Date(s.onboardDate).toLocaleString()}</td><td>${s.baseAsset}</td></tr>`).join('');
            document.getElementById('listingsBody').innerHTML = rows || '<tr><td colspan="3" class="text-slate-400">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</td></tr>';
          }catch(e){ document.getElementById('listingsBody').innerHTML='<tr><td colspan="3" class="text-red-400">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>'; }
        })();
      }

      async function renderToolSignals(){
        const sym=state.selected;
        el.toolsContent.innerHTML = `
          <div class="mb-2 flex flex-wrap items-center gap-2">
            <span class="text-slate-300">–°–∏–≥–Ω–∞–ª—ã –¥–ª—è</span>
            <input id="sigSearch" class="input w-44" style="color:#000;background:#fff" value="${sym}" placeholder="BTC / BTCUSDT"/>
            <button id="sigFind" class="btn">–ù–∞–π—Ç–∏</button>
            <span id="sigErr" class="text-red-400 text-sm" style="display:none">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</span>
          </div>
          <div id="sigTableWrap" class="text-slate-400">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</div>`;
        (function(){
          const inp=document.getElementById('sigSearch'), btn=document.getElementById('sigFind'), err=document.getElementById('sigErr');
          const clearErr=()=>{err.style.display='none'; inp.style.borderColor='';};
          const doFind=()=>{
            clearErr(); const q=(inp.value||'').trim().toUpperCase(); if(!q) return;
            if(state.map[q]){ state.selected=q; renderHeader(); renderTV(q); renderTool('signals'); renderScreener(); return; }
            const found=state.list.find(s => (state.map[s]?.base||'').toUpperCase()===q || s.includes(q));
            if(found){ state.selected=found; renderHeader(); renderTV(found); renderTool('signals'); renderScreener(); } else { err.style.display='inline'; inp.style.borderColor='#ef4444'; }
          };
          btn.onclick=doFind; inp.onkeypress=(e)=>{ if(e.key==='Enter') doFind(); }; inp.oninput=clearErr;
        })();

        // build table
        const cfg=state.params.signals, tfs=cfg.tfs;
        function sma(a,q){const t=a.slice(-q);return t.reduce((x,y)=>x+y,0)/(t.length||1);}
        function emaSeries(v,k){let e=v[0];for(let i=1;i<v.length;i++)e=v[i]*k+e*(1-k);return e;}
        function macdFinal(a,fa,sl,sg){function ser(v,p){const k=2/(p+1);let e=v[0],o=[e];for(let i=1;i<v.length;i++){e=v[i]*k+e*(1-k);o.push(e);}return o;} const ef=ser(a,fa),es=ser(a,sl); const m=ef.map((v,i)=>v-es[i]); const s=ser(m,sg); return {hist:m.at(-1)-s.at(-1)};}
        function rsi(a,p){let g=0,l=0;for(let i=1;i<=p;i++){const c=a[i]-a[i-1]; if(c>=0) g+=c; else l-=c;} for(let i=p+1;i<a.length;i++){const c=a[i]-a[i-1]; g=(g*(p-1)+(c>0?c:0))/p; l=(l*(p-1)+(c<0?-c:0))/p;} const rs=g/(l||1e-9); return 100-100/(1+rs);}

        const results=[];
        for(const tf of tfs){
          try{
            const kl=await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym}&interval=${tf}&limit=300`).then(r=>r.json());
            const closes=kl.map(k=>+k[4]); const last=closes.at(-1); const ma=sma(closes,cfg.ma); const ema=emaSeries(closes,2/(cfg.ema+1)); const macd=macdFinal(closes,cfg.macd.fast,cfg.macd.slow,cfg.macd.sig); const r=rsi(closes,cfg.rsi);
            const trend = last>ma && last>ema ? 'up' : (last<ma && last<ema ? 'down' : 'range');
            results.push({tf,ma,ema,macd,r,trend});
          }catch(e){ results.push({tf,error:true}); }
        }
        const rows=results.map(r=>{
          if(r.error) return `<tr><td>${r.tf}</td><td colspan="4" class="text-red-400">–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
          const tr=r.trend==='up'?'<span class="text-green-400">‚Üë –¢—Ä–µ–Ω–¥</span>':(r.trend==='down'?'<span class="text-red-400">‚Üì –¢—Ä–µ–Ω–¥</span>':'<span class="text-slate-400">–§–ª–µ—Ç</span>');
          const mac = r.macd.hist>0?'<span class="text-green-400">MACD+</span>':'<span class="text-red-400">MACD-</span>';
          const rsiTxt = r.r>70?'<span class="text-red-400">RSI 70+</span>':(r.r<30?'<span class="text-green-400">RSI 30-</span>':'<span class="text-slate-400">RSI</span>');
          return `<tr><td>${r.tf}</td><td>${tr}</td><td>${mac}</td><td>${rsiTxt} <span class="text-slate-400">(${n2(r.r)})</span></td><td class="text-right text-slate-400">MA ${n2(r.ma)} / EMA ${n2(r.ema)}</td></tr>`;
        }).join('');
        document.getElementById('sigTableWrap').innerHTML = `<table><thead><tr><th>TF</th><th>Trend MA50/EMA200</th><th>MACD</th><th>RSI(14)</th><th class="text-right">MA –¥–µ—Ç–∞–ª–∏</th></tr></thead><tbody>${rows}</tbody></table>`;
      }

      function renderToolNews(){
        const c=state.map[state.selected], base=c?c.base:''; const q=encodeURIComponent(base+' crypto');
        el.toolsContent.innerHTML = `<div class="text-slate-300 mb-3">–ù–æ–≤–æ—Å—Ç–∏ –ø–æ: <strong>${base||state.selected||''}</strong></div>
          <div class="flex flex-wrap gap-2 mb-2">
            <a class="btn" target="_blank" rel="noopener" href="https://www.google.com/search?q=${q}+site:coindesk.com&tbm=nws">CoinDesk</a>
            <a class="btn" target="_blank" rel="noopener" href="https://www.google.com/search?q=${q}+site:cointelegraph.com&tbm=nws">Cointelegraph</a>
            <a class="btn" target="_blank" rel="noopener" href="https://www.google.com/search?q=${q}+site:decrypt.co&tbm=nws">Decrypt</a>
            <a class="btn" target="_blank" rel="noopener" href="https://www.google.com/search?q=${q}+site:binance.com+announcement&tbm=nws">Binance Announcements</a>
            <a class="btn" target="_blank" rel="noopener" href="https://www.google.com/search?q=${q}+site:x.com">X (Twitter)</a>
          </div>`;
      }

      function bindTools(){
        const btns=document.querySelectorAll('.tools-btn');
        btns.forEach(b=>b.onclick=()=>{ btns.forEach(x=>x.classList.remove('active')); b.classList.add('active'); state.activeTool=b.getAttribute('data-tool'); renderTool(state.activeTool); });
        (btns[0]||{}).classList.add('active');
      }

      (async function init(){
        bindTools(); renderStatus();
        try{ await loadMarkets(); renderHeader(); renderScreener(); renderTV(state.selected); startWS(); renderTool(state.activeTool); }
        catch(e){ el.status.innerHTML='<span class="text-red-400">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Binance Futures</span>'; }
      })();

      el.search.onkeypress=(e)=>{ if(e.key==='Enter') applySearch(); };
      el.searchBtn.onclick=applySearch;
      el.clear.onclick=()=>{ el.search.value=''; state.search=''; el.hint.textContent=''; renderScreener(); renderTool(state.activeTool); };
      el.toggle.onclick=()=>{ state.showPrices=!state.showPrices; el.toggle.textContent=state.showPrices?'üôà –°–∫—Ä—ã—Ç—å —Ü–µ–Ω—ã':'üëÅ –ü–æ–∫–∞–∑–∞—Ç—å —Ü–µ–Ω—ã'; renderHeader(); renderScreener(); renderTool(state.activeTool); };
      el.gainers.onclick=()=>{ state.screenerView='gainers'; el.gainers.className='btn flex-1 text-white bg-green-600/80 border-green-700'; el.losers.className='btn flex-1 text-white'; renderScreener(); renderTool(state.activeTool); };
      el.losers.onclick=()=>{ state.screenerView='losers'; el.losers.className='btn flex-1 text-white bg-red-600/80 border-red-700'; el.gainers.className='btn flex-1 text-white'; renderScreener(); renderTool(state.activeTool); };
      new ResizeObserver(()=>enforceViewportRows()).observe(el.screener);
    </script>
  
<script>
// ===== Autonomous FORCE Agent with its own search =====

// Network helpers (browser-friendly CORS fallbacks)
async function FA_loadKlines(symbol){
  const base = `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=15m&limit=300`;
  const ways = [
    { url: base, tag:'FUTURES' },
    { url: `https://cors.isomorphic-git.org/${base}`, tag:'proxy:isomorphic-git' },
    { url: `https://corsproxy.io/?${encodeURIComponent(base)}`, tag:'proxy:corsproxy.io' },
  ];
  let lastErr=null;
  for(const w of ways){
    try{
      const r = await fetch(w.url,{cache:'no-store'});
      if(!r.ok) throw new Error(`${w.tag}: HTTP ${r.status}`);
      const j = await r.json();
      if(Array.isArray(j)) return { klines:j, source:w.tag };
      throw new Error(`${w.tag}: not array`);
    }catch(e){ lastErr=e; }
  }
  throw lastErr || new Error('no data');
}

async function FA_fetchTickSize(symbol){
  try{
    const r = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo',{cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const j = await r.json();
    const s = (j.symbols||[]).find(x=>x.symbol===symbol);
    if(!s) return { tick:0.01, digits:2 };
    const pf = (s.filters||[]).find(f=>f.filterType==='PRICE_FILTER');
    if (pf && pf.tickSize){
      const tick = parseFloat(pf.tickSize);
      const digs = (pf.tickSize.split('.')[1]||'').length;
      return { tick: tick>0?tick:0.01, digits: digs||2 };
    }
    const digits = Number.isFinite(s.pricePrecision)? s.pricePrecision : 2;
    return { tick: 1/Math.pow(10,digits), digits };
  }catch(_){ return { tick:0.01, digits:2 }; }
}
const FA_round=(x,t)=> (!Number.isFinite(t)||t<=0)? x : Math.round(x/t)*t;

// Indicators
const FA_sma=(a,p)=>{const t=a.slice(-p);return t.reduce((x,y)=>x+y,0)/(t.length||1)};
const FA_ema=(a,p)=>{const k=2/(p+1);let e=a[0];for(let i=1;i<a.length;i++)e=a[i]*k+e*(1-k);return e};
function FA_macdHist(a, fa=12, sl=26, sg=9){
  const ser=(v,p)=>{const k=2/(p+1);let e=v[0],o=[e];for(let i=1;i<v.length;i++){e=v[i]*k+e*(1-k);o.push(e);}return o};
  const ef=ser(a,fa), es=ser(a,sl); const m=ef.map((v,i)=>v-es[i]); const s=ser(m,sg);
  return m.at(-1)-s.at(-1);
}
function FA_rsi(a,p=14){
  if (a.length < p+2) return NaN;
  let g=0,l=0;for(let i=1;i<=p;i++){const c=a[i]-a[i-1]; if(c>=0) g+=c; else l-=c;}
  for(let i=p+1;i<a.length;i++){const c=a[i]-a[i-1]; g=(g*(p-1)+(c>0?c:0))/p; l=(l*(p-1)+(c<0?-c:0))/p;}
  const rs=g/(l||1e-9); return 100-100/(1+rs);
}
function FA_atr(kl,p=14){
  if (kl.length < p+1) return NaN;
  let trs=[];
  for(let i=1;i<kl.length;i++){
    const hi=+kl[i][2], lo=+kl[i][3], pc=+kl[i-1][4];
    trs.push(Math.max(hi-lo, Math.abs(hi-pc), Math.abs(lo-pc)));
  }
  let avg=0; for(let i=0;i<p;i++) avg+=trs[i]; avg/=p;
  for(let i=p;i<trs.length;i++) avg=(avg*(p-1)+trs[i])/p;
  return avg;
}

// Core agent: always LONG/SHORT + ATR levels + tick-size rounding
async function AGENT_run(symbolRaw){
  const symbol = (symbolRaw || 'BTCUSDT').toUpperCase();
  const { klines, source } = await FA_loadKlines(symbol);
  const closes = klines.map(k=>+k[4]);
  const last   = closes.at(-1);
  const MA50   = closes.length>=50  ? FA_sma(closes,50)  : NaN;
  const EMA200 = closes.length>=200 ? FA_ema(closes,200) : FA_ema(closes, Math.min(200, closes.length-1));
  const MACD_H = FA_macdHist(closes);
  const RSI14  = FA_rsi(closes,14);
  const ATR14  = FA_atr(klines,14);

  let scoreLong=0, scoreShort=0, notes=[];
  if (Number.isFinite(MA50) && Number.isFinite(EMA200)){
    if (last > MA50 && last > EMA200){ scoreLong+=2; notes.push('–¶–µ–Ω–∞ –≤—ã—à–µ MA50 –∏ EMA200'); }
    if (last < MA50 && last < EMA200){ scoreShort+=2; notes.push('–¶–µ–Ω–∞ –Ω–∏–∂–µ MA50 –∏ EMA200'); }
  }
  if (Number.isFinite(MACD_H)){
    if (MACD_H > 0){ scoreLong+=1; notes.push('MACD –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ > 0'); }
    if (MACD_H < 0){ scoreShort+=1; notes.push('MACD –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ < 0'); }
  }
  if (Number.isFinite(RSI14)){
    if (RSI14 > 70){ scoreShort+=1; notes.push('RSI>70 (–ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å)'); }
    if (RSI14 < 30){ scoreLong+=1; notes.push('RSI<30 (–ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å)'); }
  }

  // Force decision
  let side='NEUTRAL', confidence=0.52;
  if (scoreLong - scoreShort >= 2){ side='LONG'; confidence=0.68; }
  else if (scoreShort - scoreLong >= 2){ side='SHORT'; confidence=0.68; }
  else {
    if (Number.isFinite(EMA200) && Number.isFinite(last)){
      if (last > EMA200){ side='LONG';  confidence = 0.58; }
      else if (last < EMA200){ side='SHORT'; confidence = 0.58; }
    }
    if (side==='NEUTRAL' && Number.isFinite(MACD_H)){
      if (MACD_H > 0){ side='LONG'; confidence = Math.max(confidence, 0.56); }
      else if (MACD_H < 0){ side='SHORT'; confidence = Math.max(confidence, 0.56); }
    }
    if (side==='NEUTRAL' && Number.isFinite(RSI14)){
      if (RSI14 >= 50){ side='LONG';  confidence = Math.max(confidence, 0.54); }
      else { side='SHORT'; confidence = Math.max(confidence, 0.54); }
    }
    if (side==='NEUTRAL'){ side='LONG'; confidence=0.51; }
  }

  // Entry/SL/TP via ATR (RR~2)
  let entry=last, sl=null, tp=null;
  if (Number.isFinite(ATR14) && ATR14>0){
    if (side==='LONG'){ sl=last-1*ATR14; tp=last+2*ATR14; }
    else { sl=last+1*ATR14; tp=last-2*ATR14; }
  }else{
    const pct=0.01;
    if (side==='LONG'){ sl=last*(1-pct); tp=last*(1+2*pct); }
    else { sl=last*(1+pct); tp=last*(1-2*pct); }
  }

  const { tick, digits } = await FA_fetchTickSize(symbol).catch(()=>({tick:0.01,digits:2}));
  const entryR = FA_round(entry, tick);
  const slR    = FA_round(sl, tick);
  const tpR    = FA_round(tp, tick);
  const rr     = Math.abs((tpR-entryR)/(entryR-slR));

  return { symbol, side, confidence, entry:entryR, sl:slR, tp:tpR, rr, notes, source, ATR14, tick, digits };
}

// Render into agent panel
function AGENT_render(res){
  const box = document.getElementById('agentOut');
  if (!box) return;
  const digs = Number.isFinite(res.digits)? res.digits : 6;
  const f = (x)=> Number(x).toLocaleString('ru-RU',{minimumFractionDigits:digs, maximumFractionDigits:digs});
  const color = res.side==='LONG' ? '#22c55e' : '#ef4444';
  box.innerHTML = `
    <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
      <div>
        <span style="border:1px solid ${color};color:${color};padding:2px 10px;border-radius:999px;font-weight:700;">${res.side}</span>
        <span style="color:#94a3b8;margin-left:8px">Conf: ${(res.confidence*100|0)}%</span>
        <span style="color:#94a3b8;margin-left:8px">RR‚âà${res.rr.toFixed(2)}</span>
      </div>
      <div style="color:#94a3b8;font-size:12px;">ATR14‚âà${Number(res.ATR14||0).toFixed(6)} | —Ä–µ–∂–∏–º: —Ñ–æ—Ä—Å-—Ä–µ—à–µ–Ω–∏–µ</div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:8px;font-size:14px;">
      <div><div class="label">–í—Ö–æ–¥</div><div class="value">${f(res.entry)}</div></div>
      <div><div class="label">SL</div><div class="value">${f(res.sl)}</div></div>
      <div><div class="label">TP</div><div class="value">${f(res.tp)}</div></div>
    </div>
    <div style="margin-top:8px;color:#e2e8f0">–ò—Ç–æ–≥: <b>${res.side==='LONG'?'–õ–û–ù–ì':'–®–û–†–¢'}</b>. –í—Ö–æ–¥ –ø–æ —Ä—ã–Ω–∫—É –æ—Ç <b>${f(res.entry)}</b>, SL ‚Äî <b>${f(res.sl)}</b>, TP ‚Äî <b>${f(res.tp)}</b>.</div>
    <div style="margin-top:4px;color:#94a3b8">–ü—Ä–∏—á–∏–Ω—ã: ${(res.notes||[]).join('; ') || '‚Äî'}.</div>
  `;
}



// Wire up local search (robust: global function + event listeners + collapse on empty)
window.agent_panel_run = async function agent_panel_run() {
  const input = document.getElementById('agentSearchInput');
  const out   = document.getElementById('agentOut');
  const btn   = document.getElementById('agentSearchBtn');
  if (!input || !out) return;
  const raw = (input.value||'').trim();
  if (!raw) {
    // collapse to default state
    out.textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–∞–π—Ç–∏¬ª ‚Äî –ø–æ–ª—É—á–∏—Ç–µ –õ–û–ù–ì/–®–û–†–¢, Entry/SL/TP, RR, ATR –∏ –ø—Ä–∏—á–∏–Ω—ã.';
    if (btn) btn.disabled = true;
    return;
  }
  const sym = (raw.endsWith('USDT') ? raw : raw ? raw+'USDT' : 'BTCUSDT').toUpperCase();
  out.textContent = '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é‚Ä¶';
  if (btn) btn.disabled = true;
  try {
    const res = await AGENT_run(sym);
    AGENT_render(res);
  } catch(e) {
    out.innerHTML = '<span style="color:#f87171">–û—à–∏–±–∫–∞: '+(e.message||e)+'</span>';
  } finally {
    if (btn) btn.disabled = false;
  }
};

(function attach_agent_panel_listeners(){
  try{
    const input = document.getElementById('agentSearchInput');
    const btn   = document.getElementById('agentSearchBtn');
    const out   = document.getElementById('agentOut');
    if (btn) btn.addEventListener('click', window.agent_panel_run);
    if (input) {
      input.addEventListener('keydown', ev=>{ if (ev.key==='Enter') window.agent_panel_run(); });
      // collapse/restore on input
      input.addEventListener('input', ()=>{
        const val = (input.value||'').trim();
        if (!val) {
          out.textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–∞–π—Ç–∏¬ª ‚Äî –ø–æ–ª—É—á–∏—Ç–µ –õ–û–ù–ì/–®–û–†–¢, Entry/SL/TP, RR, ATR –∏ –ø—Ä–∏—á–∏–Ω—ã.';
          if (btn) btn.disabled = true;
        } else {
          if (btn) btn.disabled = false;
        }
      });
      // initialize disabled state
      const initVal = (input.value||'').trim();
      if (btn) btn.disabled = !initVal;
      if (!initVal) out.textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–∞–π—Ç–∏¬ª ‚Äî –ø–æ–ª—É—á–∏—Ç–µ –õ–û–ù–ì/–®–û–†–¢, Entry/SL/TP, RR, ATR –∏ –ø—Ä–∏—á–∏–Ω—ã.';
    }
  }catch(_){}
})();

document.addEventListener('DOMContentLoaded', ()=>{
  try{
    const input = document.getElementById('agentSearchInput');
    const btn   = document.getElementById('agentSearchBtn');
    const out   = document.getElementById('agentOut');
    if (btn && !btn._bound){ btn.addEventListener('click', window.agent_panel_run); btn._bound=true; }
    if (input && !input._bound){
      input.addEventListener('keydown', ev=>{ if (ev.key==='Enter') window.agent_panel_run(); });
      input.addEventListener('input', ()=>{
        const val = (input.value||'').trim();
        if (!val) {
          out.textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–∞–π—Ç–∏¬ª ‚Äî –ø–æ–ª—É—á–∏—Ç–µ –õ–û–ù–ì/–®–û–†–¢, Entry/SL/TP, RR, ATR –∏ –ø—Ä–∏—á–∏–Ω—ã.';
          if (btn) btn.disabled = true;
        } else {
          if (btn) btn.disabled = false;
        }
      });
      input._bound=true;
      // initialize
      const initVal = (input.value||'').trim();
      if (btn) btn.disabled = !initVal;
      if (!initVal) out.textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–∞–π—Ç–∏¬ª ‚Äî –ø–æ–ª—É—á–∏—Ç–µ –õ–û–ù–ì/–®–û–†–¢, Entry/SL/TP, RR, ATR –∏ –ø—Ä–∏—á–∏–Ω—ã.';
    }
  }catch(_){
  }
});
</script>




<script>
const OI_FORCE_PROXY = (localStorage.getItem('force_proxy_oi')==='1');
function __wraps(url){
  const arr = [ (u)=>u, (u)=>'https://cors.isomorphic-git.org/'+u, (u)=>'https://api.allorigins.win/raw?url='+encodeURIComponent(u), (u)=>'https://corsproxy.io/?'+encodeURIComponent(u) ];
  return (OI_FORCE_PROXY || location.protocol==='file:') ? arr.slice(1) : arr;
}
async function OI_fetchNow(symbol){
  const base = 'https://fapi.binance.com/fapi/v1/openInterest?symbol='+encodeURIComponent(symbol);
  let lastErr=null;
  for(const wrap of __wraps(base)){
    try{
      const r = await fetch(wrap(base), {cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      if (j && j.openInterest!=null) return { oi:Number(j.openInterest), time:j.time||Date.now() };
    }catch(e){ lastErr=e; }
  }
  throw lastErr || new Error('OI fetch failed');
}
async function OI_fetchHist(symbol, period='5m', limit=2){
  const base = `https://www.binance.com/futures/data/openInterestHist?symbol=${symbol}&period=${period}&limit=${limit}`;
  let lastErr=null;
  for(const wrap of __wraps(base)){
    try{
      const r = await fetch(wrap(base), {cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      if (Array.isArray(j)) return j.map(x=>({ t:Number(x.timestamp||x.time||0), oi:Number(x.sumOpenInterest||x.openInterest||x.oi||0) }));
    }catch(e){ lastErr=e; }
  }
  throw lastErr || new Error('OI hist failed');
}
async function OI_fetchTaker(symbol, period='5m', limit=1){
  const base = `https://www.binance.com/futures/data/takerlongshortRatio?symbol=${symbol}&period=${period}&limit=${limit}`;
  let lastErr=null;
  for(const wrap of __wraps(base)){
    try{
      const r = await fetch(wrap(base), {cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      if (Array.isArray(j) && j.length){
        const it = j[j.length-1];
        return { buy:Number(it.buyVol||it.buy), sell:Number(it.sellVol||it.sell), t:Number(it.timestamp||it.time||0) };
      }
    }catch(e){ lastErr=e; }
  }
  throw lastErr || new Error('taker failed');
}
</script>


<script>
function OI_fmtNum(x){ return Number(x).toLocaleString('en-US',{maximumFractionDigits:0}); }

function OI_setPeriod(p){
  const allowed = new Set(['1m','5m','15m']);
  if(!allowed.has(p)) return;
  state.oiPeriod = p;
  // toggle active class
  [['1m','oiP_1m'],['5m','oiP_5m'],['15m','oiP_15m']].forEach(([val,id])=>{
    const btn = document.getElementById(id);
    if (!btn) return;
    if (val===p) btn.classList.add('active'); else btn.classList.remove('active');
  });
  if (state.selected) OI_updateFloat(state.selected);
}
async function OI_updateFloat(sym){ const period = (state.oiPeriod||'5m');
  const box = document.getElementById('oiFloat');
  const closeBtn = document.getElementById('oiF_close');
  if (closeBtn && !closeBtn._bound) { closeBtn.addEventListener('click', ()=> box.classList.add('hidden')); closeBtn._bound=true; }

  
    const buyLbl = document.getElementById('oiF_buyLbl');
    const sellLbl = document.getElementById('oiF_sellLbl');
    if (buyLbl) buyLbl.textContent = `Taker Buy (${period})`;
    if (sellLbl) sellLbl.textContent = `Taker Sell (${period})`;
    try{
    const [now, hist, taker] = await Promise.allSettled([
      OI_fetchNow(sym), OI_fetchHist(sym,period,50), OI_fetchTaker(sym,period,1)
    ]);
    let oiNow = (now.status==='fulfilled') ? now.value.oi : NaN;
    let oiPrev = NaN;
    if (hist.status==='fulfilled' && Array.isArray(hist.value) && hist.value.length>=2){
      const arr = hist.value;
      const last = arr[arr.length-1].oi;
      const prev = arr[arr.length-2].oi;
      if (!Number.isFinite(oiNow)) oiNow = last;
      oiPrev = prev;
    }
    const buy = taker.status==='fulfilled' ? taker.value.buy : NaN;
    const sell = taker.status==='fulfilled' ? taker.value.sell : NaN;
    const total = (Number.isFinite(buy)?buy:0) + (Number.isFinite(sell)?sell:0);
    const pBuy = total>0 ? (buy/total*100) : NaN;
    const pSell = total>0 ? (sell/total*100) : NaN;
    const dOI = (Number.isFinite(oiNow)&&Number.isFinite(oiPrev)) ? (oiNow-oiPrev) : NaN;
    const dPct = (Number.isFinite(oiNow)&&Number.isFinite(oiPrev) && oiPrev>0) ? (dOI/oiPrev*100) : NaN;
    const ts = (now.status==='fulfilled' && now.value.time) || (taker.status==='fulfilled' && taker.value.t) || Date.now();

    document.getElementById('oiF_sym').textContent = sym;
    document.getElementById('oiF_buy').textContent = Number.isFinite(buy)? OI_fmtNum(buy) : '‚Äî';
    document.getElementById('oiF_sell').textContent = Number.isFinite(sell)? OI_fmtNum(sell) : '‚Äî';
    document.getElementById('oiF_buyPct').textContent  = Number.isFinite(pBuy)? `(${pBuy.toFixed(1)}%)` : '';
    document.getElementById('oiF_sellPct').textContent = Number.isFinite(pSell)? `(${pSell.toFixed(1)}%)` : '';
    document.getElementById('oiF_total').textContent = total>0 ? OI_fmtNum(total) : '‚Äî';
    document.getElementById('oiF_now').textContent = Number.isFinite(oiNow)? OI_fmtNum(oiNow) : '‚Äî';
    const elD = document.getElementById('oiF_delta');
    elD.textContent = Number.isFinite(dOI) ? `${dOI>=0?'+':''}${OI_fmtNum(dOI)} ${Number.isFinite(dPct)?'('+(dPct>=0?'+':'')+dPct.toFixed(2)+'%)':''}` : '‚Äî';
    elD.className = 'font-mono text-sm ' + (Number.isFinite(dOI) ? (dOI>=0?'text-green-400':'text-red-400') : 'text-slate-300');
    document.getElementById('oiF_ts').textContent = new Date(ts).toLocaleString();

    box.classList.remove('hidden');
  }catch(e){
    document.getElementById('oiF_sym').textContent = sym;
    document.getElementById('oiF_buy').textContent = '‚Äî';
    document.getElementById('oiF_sell').textContent = '‚Äî';
    document.getElementById('oiF_buyPct').textContent  = '';
    document.getElementById('oiF_sellPct').textContent = '';
    document.getElementById('oiF_total').textContent = '‚Äî';
    document.getElementById('oiF_now').textContent = '‚Äî';
    document.getElementById('oiF_delta').textContent = '‚Äî';
    document.getElementById('oiF_delta').className = 'font-mono text-sm text-slate-300';
    document.getElementById('oiF_ts').textContent = new Date().toLocaleString();
    box.classList.remove('hidden');
  }
}
</script>




<script>
// Robust sync on click: TV + OI + Agent
document.addEventListener('DOMContentLoaded', ()=>{
  const root = document.getElementById('screenerList');
  if (!root) return;
  root.addEventListener('click', (ev)=>{
    const n = ev.target.closest('[data-sym],[data-symbol]'); if (!n) return;
    const s = n.getAttribute('data-sym') || n.getAttribute('data-symbol'); if (!s) return;
    try{ if (window.renderTV) renderTV(s); }catch(_){}
    try{ if (window.OI_updateFloat) OI_updateFloat(s); }catch(_){}
    const agIn = document.getElementById('agentSearchInput');
    if (agIn){ agIn.value = s; }
    if (window.agent_panel_run) window.agent_panel_run();
    try{ if (window.state){ window.state.selected = s; if (window.renderHeader) renderHeader(); } }catch(_){}
  }, {passive:true});
});
</script>














<script>
// ---- Runtime '–ê–Ω–æ–º–∞–ª–∏–∏' module (filters + autoscan + heatmap) ----
document.addEventListener('DOMContentLoaded', ()=>{
  const btn = document.querySelector('[data-tool="signals"]');
  if (btn) btn.textContent = '–ê–Ω–æ–º–∞–ª–∏–∏';
});
const A_sma=(a,p)=>{const t=a.slice(-p);return t.reduce((x,y)=>x+y,0)/(t.length||1)};
function A_atr(kl,p=20){
  if (!kl || kl.length < p+1) return {atr:NaN, trs:[]};
  let trs=[];
  for(let i=1;i<kl.length;i++){
    const hi=+kl[i][2], lo=+kl[i][3], pc=+kl[i-1][4];
    trs.push(Math.max(hi-lo, Math.abs(hi-pc), Math.abs(lo-pc)));
  }
  let avg=0; for(let i=0;i<p;i++) avg+=trs[i]; avg/=p;
  for(let i=p;i<trs.length;i++) avg=(avg*(p-1)+trs[i])/p;
  return {atr:avg, trs};
}
async function A_fetch24hr(){
  const base = 'https://fapi.binance.com/fapi/v1/ticker/24hr';
  const ways=[base, 'https://cors.isomorphic-git.org/'+base, 'https://corsproxy.io/?'+encodeURIComponent(base)];
  for(const u of ways){
    try{ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) continue; const j=await r.json(); if(Array.isArray(j)) return j; }catch(_){}
  } throw new Error('24hr unavailable');
}
async function A_fetchKlines(symbol, interval, limit=288){
  const base = `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
  const ways=[base, `https://isomorphic-git.org/cors/${base}`, `https://cors.isomorphic-git.org/${base}`, `https://corsproxy.io/?${encodeURIComponent(base)}`];
  for(const u of ways){
    try{ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) continue; const j=await r.json(); if(Array.isArray(j)) return j; }catch(_){}
  } throw new Error('klines unavailable '+symbol);
}
function A_scanAnoms(kl){
  const rows = kl.map(k=>({t:+k[0], o:+k[1], h:+k[2], l:+k[3], c:+k[4], v:+k[5]}));
  const vols=rows.map(r=>r.v);
  const {atr:ATR, trs} = A_atr(kl,20);
  const volAvg = A_sma(vols,20);
  let best=null, score=0, flagsBest=null;
  for(let i=1;i<rows.length;i++){
    const r=rows[i], p=rows[i-1];
    const chg = (r.c - p.c)/p.c * 100;
    const tr  = trs[i-1] || 0;
    const fchg = Math.abs(chg) >= 3;
    const fvol = r.v >= 3*volAvg;
    const fatr = Number.isFinite(ATR) && ATR>0 && tr >= 2*ATR;
    if (fchg || fvol || fatr){
      const s = (fvol?1.2:0) + (fatr?1.0:0) + (fchg?0.8:0);
      if (!best || r.t > best.time){
        best = { time:r.t, change:chg, range:(r.h-r.l)/p.c*100, volume:r.v };
        flagsBest = { fchg, fvol, fatr, note: [
          fchg ? `Œî ${chg.toFixed(2)}%` : null,
          fvol ? `V √ó${(r.v/volAvg).toFixed(1)}` : null,
          fatr ? `ATR √ó${(tr/ATR).toFixed(1)}` : null,
        ].filter(Boolean).join(' ¬∑ ') };
      }
      score = Math.max(score, s);
    }
  }
  if (!best) return null;
  return { ...best, ...flagsBest, score };
}
function openAllHook(scope){
  scope.querySelectorAll('[data-open]').forEach(b=>{
    b.onclick = ()=>{
      const s = b.getAttribute('data-open');
      try{ if (window.renderTV) renderTV(s); }catch(_){}
      try{ if (window.OI_updateFloat) OI_updateFloat(s); }catch(_){}
      const agIn=document.getElementById('agentSearchInput'); if (agIn){ agIn.value=s; }
      if (window.agent_panel_run) window.agent_panel_run();
      if (window.state){ state.selected=s; if (window.renderHeader) renderHeader(); }
    };
  });
}
const badgeUpdate = (n)=>{
  const btn = document.querySelector('[data-tool="signals"]');
  if (btn) btn.textContent = `–ê–Ω–æ–º–∞–ª–∏–∏ (${n})`;
};
function heat(score){
  const x = Math.max(0, Math.min(1, score/3));
  const a = 0.12 + 0.28*x;
  const h = 210*(1-x);
  return `hsla(${h}, 90%, 40%, ${a})`;
}

window.renderToolSignals = async function renderToolSignals(){
  const elTools = document.getElementById('toolsContent') || (window.el && window.el.toolsContent);
  if (!elTools) return;
  elTools.innerHTML = `
    <div class="mb-2 flex flex-wrap items-center gap-3">
      <span class="text-slate-300">–ê–Ω–æ–º–∞–ª–∏–∏ (24—á)</span>
      <label class="text-slate-400 text-sm">TF:
        <select id="anomTF" class="input w-24" style="color:#000;background:#fff">
          <option value="5m" selected>5m</option>
          <option value="15m">15m</option>
        </select>
      </label>
      <label class="text-slate-400 text-sm">–¢–æ–ø:
        <select id="anomN" class="input w-24" style="color:#000;background:#fff">
          <option value="20">20</option>
          <option value="30" selected>30</option>
          <option value="50">50</option>
        </select>
      </label>
      <div class="flex items-center gap-2 text-sm">
        <span class="text-slate-400">–§–∏–ª—å—Ç—Ä:</span>
        <label class="flex items-center gap-1"><input id="fChg" type="checkbox" checked> Œî%</label>
        <label class="flex items-center gap-1"><input id="fVol" type="checkbox" checked> –û–±—ä—ë–º</label>
        <label class="flex items-center gap-1"><input id="fAtr" type="checkbox" checked> ATR</label>
      </div>
      <div class="flex items-center gap-2 text-sm">
        <span class="text-slate-400">–ê–≤—Ç–æ:</span>
        <select id="anomAuto" class="input w-28" style="color:#000;background:#fff">
          <option value="0" selected>–í—ã–∫–ª</option>
          <option value="5">–∫–∞–∂–¥—ã–µ 5–º</option>
          <option value="10">–∫–∞–∂–¥—ã–µ 10–º</option>
        </select>
      </div>
      <button id="anomScan" class="btn" type="button">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
    <div id="anomListWrap" class="text-slate-400" style="overflow-y:auto; border:1px solid #1f2937; border-radius:12px;"></div>`;

  let timer=null, lastResults=[];
  let sortKey = 'score', sortDir = -1;

  function setViewportTo8Rows(){
    const wrap = document.getElementById('anomListWrap');
    const firstRow = wrap.querySelector('tbody tr');
    const thead = wrap.querySelector('thead');
    if (!firstRow) return;
    const rh = firstRow.getBoundingClientRect().height || 40;
    const hh = thead ? (thead.getBoundingClientRect().height||28) : 28;
    wrap.style.maxHeight = Math.round(rh*8 + hh + 8) + 'px';
  }

  function renderTable(list){
    const fChg = document.getElementById('fChg').checked;
    const fVol = document.getElementById('fVol').checked;
    const fAtr = document.getElementById('fAtr').checked;
    let results = list.filter(it => (fChg && it.fchg) || (fVol && it.fvol) || (fAtr && it.fatr));

    const get = (it)=>{
      if (sortKey==='symbol') return it.symbol;
      if (sortKey==='time') return it.time;
      if (sortKey==='change') return it.change;
      if (sortKey==='range') return it.range;
      if (sortKey==='volume') return it.volume;
      return it.score;
    };
    results = results.slice().sort((a,b)=>{
      const A = get(a), B = get(b);
      if (A<B) return -1*sortDir;
      if (A>B) return  1*sortDir;
      return (b.time - a.time);
    });

    const rows = results.map((it,i)=>{
      const dt = new Date(it.time).toLocaleString('ru-RU');
      const dirArrow = it.change>=0 ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
      const bg = heat(it.score);
      return `<tr >
        <td class="text-slate-300">${i+1}</td>
        <td class="text-slate-100 font-medium">${it.symbol}</td>
        <td class="text-slate-200">${dt}</td>
        <td class="text-slate-200">${dirArrow} ${it.change.toFixed(2)}%</td>
        <td class="text-slate-200">${it.range.toFixed(2)}%</td>
        <td class="text-slate-200">${Number(it.volume).toLocaleString('ru-RU')}</td>
        <td class="text-slate-100">${it.note}</td>
        <td><button class="btn btn-xs" data-open="${it.symbol}">–û—Ç–∫—Ä—ã—Ç—å</button></td>
      </tr>`;
    }).join('');

    const wrap = document.getElementById('anomListWrap');
    wrap.innerHTML = `<table class="w-full text-sm">
      <thead class="sticky top-0 bg-slate-900/80 backdrop-blur">
        <tr>
          <th data-sort="rank"   class="cursor-pointer">#</th>
          <th data-sort="symbol" class="cursor-pointer">–¢–∏–∫–µ—Ä</th>
          <th data-sort="time"   class="cursor-pointer">–í—Ä–µ–º—è</th>
          <th data-sort="change" class="cursor-pointer">Œî%</th>
          <th data-sort="range"  class="cursor-pointer">–î–∏–∞–ø–∞–∑–æ–Ω%</th>
          <th data-sort="volume" class="cursor-pointer">–û–±—ä—ë–º</th>
          <th>–§–∞–∫—Ç–æ—Ä—ã</th><th></th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>`;

    wrap.querySelectorAll('th[data-sort]').forEach(th=>{
      th.onclick = ()=>{
        const k = th.getAttribute('data-sort');
        if (k==='rank'){ sortKey='score'; sortDir=-1; }
        else { sortKey=k; sortDir = (sortKey===k) ? -sortDir : -1; }
        renderTable(results);
      };
    });

    document.querySelectorAll('[data-open]').forEach(b=>{
      b.onclick = ()=>{
        const s=b.getAttribute('data-open');
        try{ if (window.renderTV) renderTV(s); }catch(_){}
        try{ if (window.OI_updateFloat) OI_updateFloat(s); }catch(_){}
        const agIn=document.getElementById('agentSearchInput'); if (agIn){ agIn.value=s; }
        if (window.agent_panel_run) window.agent_panel_run();
        if (window.state){ state.selected=s; if (window.renderHeader) renderHeader(); }
      };
    });

    badgeUpdate(results.length);
    setViewportTo8Rows();
    window.addEventListener('resize', setViewportTo8Rows, {passive:true});
  }

  async function scanMarket(){
    const tf = document.getElementById('anomTF').value || '5m';
    const N  = parseInt(document.getElementById('anomN').value || '30',10);
    const wrap = document.getElementById('anomListWrap');
    wrap.textContent = '–°–∫–∞–Ω–∏—Ä—É—é —Ä—ã–Ω–æ–∫‚Ä¶';
    try{
      const all = await A_fetch24hr();
      let symbols = all
        .filter(x => x.symbol && x.symbol.endsWith('USDT') && !/UPUSDT|DOWNUSDT|BULL|BEAR|[0-9]SUSDT|[0-9]LUSDT/.test(x.symbol))
        .sort((a,b)=> (+b.quoteVolume) - (+a.quoteVolume))
        .slice(0, N)
        .map(x=>x.symbol);
      if (window.state && Array.isArray(state.list) && state.list.length){
        const set = new Set(symbols);
        const ordered = state.list.filter(s => set.has(s)).slice(0,N);
        if (ordered.length) symbols = ordered;
      }
      const limit = tf==='5m' ? 288 : 200;
      const pool = 5;
      let i=0, results=[];
      async function worker(){
        while(i < symbols.length){
          const s = symbols[i++];
          try{
            const kl = await A_fetchKlines(s, tf, limit);
            const ev = A_scanAnoms(kl);
            if (ev) results.push({ symbol:s, ...ev });
          }catch(_){}
        }
      }
      await Promise.all(Array.from({length:pool}, worker));
      results.sort((a,b)=> (b.score - a.score) || (b.time - a.time));
      renderTable(results);
    }catch(e){
      document.getElementById('anomListWrap').innerHTML = '<span class="text-red-400">–û—à–∏–±–∫–∞: '+(e.message||e)+'</span>';
    }
  }

  document.getElementById('anomScan').onclick = scanMarket;
  ['fChg','fVol','fAtr'].forEach(id=>{
    document.getElementById(id).addEventListener('change', ()=> scanMarket());
  });
  function applyAuto(){
    if (window._anomTimer) { clearInterval(window._anomTimer); window._anomTimer=null; }
    const mins = parseInt(document.getElementById('anomAuto').value,10);
    if (mins>0){
      window._anomTimer = setInterval(scanMarket, mins*60*1000);
    }
  }
  document.getElementById('anomAuto').addEventListener('change', applyAuto);
  scanMarket();
  applyAuto();
};
</script>


<script>
// ==== Unified appSelectSymbol(s) ‚Äî –æ–¥–∏–Ω –≤—Ö–æ–¥ –¥–ª—è TV + OI + –ê–≥–µ–Ω—Ç ====
(function(){
  // –æ—Ç–º–µ–Ω–∞/–¥–µ–±–∞—É–Ω—Å –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–∏—Ä—É—é—â–∏—Ö –≤—ã–∑–æ–≤–æ–≤
  let oiTimer = null;
  window.appSelectSymbol = function(symbolRaw){
    if (!symbolRaw) return;
    let s = (''+symbolRaw).trim().toUpperCase();
    if (/PERP$/.test(s)) s = s.replace(/PERP$/,'');
    if (!/USDT$/.test(s)) s = s + 'USDT';

    // –æ–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ/—Ö–µ–¥–µ—Ä
    try { if (window.state){ state.selected = s; if (window.renderHeader) renderHeader(); } } catch(_){}

    // –≥—Ä–∞—Ñ–∏–∫
    try { if (window.renderTV) renderTV(s); } catch(_){}

    // OI ‚Äî –ª—ë–≥–∫–∏–π –¥–µ–±–∞—É–Ω—Å, —á—Ç–æ–±—ã –Ω–µ –¥–µ—Ä–≥–∞—Ç—å API –¥–≤–∞–∂–¥—ã –ø—Ä–∏ –¥–≤–æ–π–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö
    if (oiTimer) clearTimeout(oiTimer);
    oiTimer = setTimeout(()=>{
      try { if (window.OI_updateFloat) OI_updateFloat(s); } catch(_){}
    }, 50);

    // –∞–≥–µ–Ω—Ç
    try {
      const agIn = document.getElementById('agentSearchInput');
      if (agIn){ agIn.value = s; }
      if (window.agent_panel_run) window.agent_panel_run();
    } catch(_){}
  };
})();
</script>


<script>
// Screener/Top ‚Üí appSelectSymbol (–Ω–∞–¥—ë–∂–Ω—ã–π –¥–µ–ª–µ–≥–∞—Ç)
document.addEventListener('DOMContentLoaded', ()=>{
  const root = document.getElementById('screenerList');
  if (!root) return;
  root.addEventListener('click', (ev)=>{
    const n = ev.target.closest('[data-sym],[data-symbol]');
    if (!n) return;
    const s = n.getAttribute('data-sym') || n.getAttribute('data-symbol');
    if (s && window.appSelectSymbol) appSelectSymbol(s);
  }, {passive:true});
});
</script>


<script>
// –í–µ—Ä—Ö–Ω–∏–π –ø–æ–∏—Å–∫ ‚Üí appSelectSymbol; –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Å–æ–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è)
(function(){
  function findInputs(){
    const set = new Set();
    const sels = [
      '#globalSearch', '#searchInput', '#pairSearch', '#searchTop',
      'header input[type="search"]', 'input[type="search"]',
      'input[placeholder*="BTC"]', 'input[placeholder*="–ù–∞–π—Ç–∏"]', 'input[placeholder*="–ü–æ–∏—Å–∫"]'
    ];
    sels.forEach(sel => document.querySelectorAll(sel).forEach(el => set.add(el)));
    return Array.from(set);
  }
  function findButtons(inp){
    const res=[];
    const parent = (inp && inp.closest('form,div,section,header')) || document.body;
    parent.querySelectorAll('button, input[type="submit"]').forEach(b=>{
      const t = (b.value || b.textContent || '').trim();
      if (/^(–ù–∞–π—Ç–∏|Search)$/i.test(t)) res.push(b);
    });
    return res;
  }
  function submit(val){
    const q = (val||'').trim();
    if (!q){
      try{ if (window.agent_panel_collapse) agent_panel_collapse(); }catch(_){}
      return;
    }
    if (window.appSelectSymbol) appSelectSymbol(q);
  }
  function wireOne(inp){
    if (!inp || inp.dataset.wiredTopSearch) return;
    inp.dataset.wiredTopSearch = '1';
    // —á–∏—Ç–∞–µ–º—ã–π –∏–Ω–ø—É—Ç
    inp.style.color='#000'; if (!inp.style.background) inp.style.background='#fff';
    inp.addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); submit(inp.value); }});
    inp.addEventListener('input', ()=>{
      if (!inp.value.trim()){
        try{ if (window.agent_panel_collapse) agent_panel_collapse(); }catch(_){}
      }
    });
    findButtons(inp).forEach(btn=>{
      if (!btn.dataset.wiredTopSearch){
        btn.dataset.wiredTopSearch='1';
        btn.addEventListener('click', (e)=>{ e.preventDefault(); submit(inp.value); });
      }
    });
  }
  function wireAll(){ findInputs().forEach(wireOne); }
  document.addEventListener('DOMContentLoaded', wireAll);
  let i=0, t=setInterval(()=>{ wireAll(); if (++i>20) clearInterval(t); }, 300);
})();
</script>


<script>
// –ê–Ω–æ–º–∞–ª–∏–∏: –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ ¬´–û—Ç–∫—Ä—ã—Ç—å¬ª ‚Üí appSelectSymbol
document.addEventListener('DOMContentLoaded', ()=>{
  const wrap = document.getElementById('anomListWrap');
  if (!wrap) return;
  wrap.addEventListener('click', (ev)=>{
    const b = ev.target.closest('[data-open]');
    if (!b) return;
    const s = b.getAttribute('data-open');
    if (s && window.appSelectSymbol) appSelectSymbol(s);
  });
});
</script>


<script>
// Top search direct hook ‚Üí appSelectSymbol
document.addEventListener('DOMContentLoaded', ()=>{
  const ids = ['globalSearch','searchInput','pairSearch','searchTop'];
  ids.forEach(id=>{
    const inp = document.getElementById(id);
    if (!inp || inp.dataset.topHooked) return;
    inp.dataset.topHooked='1';
    inp.style.color='#000'; if (!inp.style.background) inp.style.background='#fff';
    const submit = ()=>{ const v = (inp.value||'').trim(); if (v && window.appSelectSymbol) appSelectSymbol(v); };
    inp.addEventListener('keydown', e=>{ if (e.key==='Enter'){ e.preventDefault(); submit(); }});
  });
});
</script>


<script>
// === FORCE Volumes Clickability (works even with dynamic render) ===
(function(){
  function normalize(sym){
    if (!sym) return null;
    let s = (''+sym).trim().toUpperCase();
    s = s.replace(/\s+/g,'');
    s = s.replace('/', ''); // BTC/USDT -> BTCUSDT
    if (/PERP$/.test(s)) s = s.replace(/PERP$/,'');
    if (!/USDT$/.test(s)) s = s + 'USDT';
    s = s.replace(/[^A-Z0-9]/g,'');
    if (!/^[A-Z0-9]{3,}$/.test(s)) return null;
    return s;
  }
  function findSymFromNode(node){
    if (!node) return null;
    let cur = node;
    for (let i=0;i<5 && cur;i++){
      if (cur.getAttribute){
        const s = cur.getAttribute('data-sym') || cur.getAttribute('data-symbol') || cur.getAttribute('data-ticker');
        if (s) return normalize(s);
      }
      cur = cur.parentElement;
    }
    const row = node.closest('tr, .row, .item, li, div');
    const txt = (row ? row.innerText : node.innerText) || '';
    const pats = [/([A-Z0-9]{2,})\s*\/\s*USDT/, /([A-Z0-9]{2,})USDT/, /\b([A-Z]{2,10})\b/];
    for (const rx of pats){
      const m = txt.toUpperCase().match(rx);
      if (m && m[1]){
        const sym = normalize(m[1] + (m[0].includes('USDT') ? '' : 'USDT'));
        if (sym) return sym;
      }
    }
    return null;
  }
  function inVolumesSection(node){
    const sec = node.closest('#volumesList, #volumeList, #volumesTable, #volumeTable, [data-tool=\"volumes\"], [data-panel=\"volumes\"], .volumes');
    if (sec) return sec;
    const box = node.closest('section,div,table');
    if (!box) return null;
    const head = (box.querySelector('h2,h3,h4,.title,.header')||{}).textContent || '';
    if (/–æ–±—ä[e—ë]–º/i.test(head)) return box;
    return null;
  }
  function handleClick(ev){
    const sec = inVolumesSection(ev.target);
    if (!sec) return;
    const sym = findSymFromNode(ev.target);
    if (!sym) return;
    ev.preventDefault();
    if (window.appSelectSymbol) appSelectSymbol(sym);
  }
  document.addEventListener('click', handleClick, {passive:false});
  const css = document.createElement('style');
  css.textContent = `
    #volumesList [data-sym], #volumesList [data-symbol], #volumesList [data-ticker],
    #volumeList [data-sym], #volumeList [data-symbol], #volumeList [data-ticker],
    #volumesTable [data-sym], #volumesTable [data-symbol], #volumesTable [data-ticker],
    #volumeTable [data-sym], #volumeTable [data-symbol], #volumeTable [data-ticker],
    [data-tool="volumes"] [data-sym], [data-tool="volumes"] [data-symbol], [data-tool="volumes"] [data-ticker],
    .volumes [data-sym], .volumes [data-symbol], .volumes [data-ticker] { cursor: pointer; text-decoration: none; }
  `;
  document.head.appendChild(css);
})();
</script>


<script>
// --- Volumes table: make ONLY the ticker cell clickable (robust) ---
(function(){
  function normalize(sym){
    if (!sym) return null;
    let s = (''+sym).trim().toUpperCase();
    s = s.replace(/\s+/g,'');
    s = s.replace('/', '');
    if (/PERP$/.test(s)) s = s.replace(/PERP$/,'');
    if (!/USDT$/.test(s)) s = s + 'USDT';
    s = s.replace(/[^A-Z0-9]/g,'');
    return s;
  }
  function markTickersInVolumes(root){
    if (!root) return;
    // find tables that have header "–ü–∞—Ä–∞"
    const tables = Array.from(root.querySelectorAll('table')).filter(tb=>{
      const ths = Array.from(tb.querySelectorAll('thead th')).map(th=>(th.textContent||'').trim());
      return ths.some(t=>/^–ø–∞—Ä–∞$/i.test(t)) && ths.some(t=>/–æ–±—ä.?–º/i.test(t));
    });
    tables.forEach(tb=>{
      const rows = tb.querySelectorAll('tbody tr');
      rows.forEach(tr=>{
        const tds = tr.querySelectorAll('td');
        if (tds.length < 2) return;
        const cell = tds[1]; // –∫–æ–ª–æ–Ω–∫–∞ "–ü–∞—Ä–∞"
        const text = (cell.textContent||'').trim();
        const sym = normalize(text);
        if (!sym) return;
        cell.dataset.ticker = sym;
        cell.classList.add('volumes-ticker');
        if (!cell.dataset.clickWired){
          cell.dataset.clickWired = '1';
          cell.style.cursor = 'pointer';
          cell.addEventListener('click', (e)=>{
            e.preventDefault();
            if (window.appSelectSymbol) appSelectSymbol(sym);
          });
        }
      });
    });
  }
  function setup(){
    const containers = [
      document.getElementById('volumesList'),
      document.getElementById('volumeList'),
      document.getElementById('volumesTable'),
      document.getElementById('volumeTable'),
      document.querySelector('[data-tool="volumes"]'),
      document.querySelector('[data-panel="volumes"]'),
      document.getElementById('toolsContent')
    ].filter(Boolean);
    containers.forEach(markTickersInVolumes);

    // Observe dynamic updates
    const host = document.getElementById('toolsContent') || document.body;
    const mo = new MutationObserver(()=>{
      containers.forEach(markTickersInVolumes);
    });
    mo.observe(host, {childList:true, subtree:true});
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', setup);
  } else {
    setup();
  }
})();
</script>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const b1=document.getElementById('oiP_1m');
  const b5=document.getElementById('oiP_5m');
  const b15=document.getElementById('oiP_15m');
  if(b1 && !b1._oiBound){ b1.addEventListener('click', ()=>OI_setPeriod('1m')); b1._oiBound=true; }
  if(b5 && !b5._oiBound){ b5.addEventListener('click', ()=>OI_setPeriod('5m')); b5._oiBound=true; }
  if(b15 && !b15._oiBound){ b15.addEventListener('click', ()=>OI_setPeriod('15m')); b15._oiBound=true; }
});
</script></body>
</html>
